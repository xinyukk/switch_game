<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥³å·«çš„æ¯’è¯ (P2Pç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS (å›½å†… BootCDN åŠ é€Ÿ) -->
    <script src="https://cdn.bootcdn.net/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .ios-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .ios-btn {
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .ios-btn:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinner {
            border: 3px solid rgba(0, 113, 227, 0.1);
            border-left-color: #0071e3;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Screen 1: Lobby -->
    <div id="screen-lobby" class="w-full max-w-md space-y-6 slide-up text-center">
        <div class="pt-8 pb-4">
            <h1 class="text-4xl font-extrabold tracking-tight text-gray-900 mb-1">å¥³å·«çš„æ¯’è¯</h1>
            <p class="text-gray-500 text-sm font-medium tracking-wide">å›½å†…ç•…ç© Â· P2Pè”æœºç‰ˆ</p>
        </div>

        <div class="space-y-4 px-2">
            <button onclick="createRoom()" class="w-full bg-[#0071e3] hover:bg-[#0077ED] text-white font-semibold py-5 px-8 rounded-2xl shadow-lg ios-btn flex items-center justify-center gap-3">
                <span>ğŸ </span> åˆ›å»ºæˆ¿é—´ (æˆ‘æ˜¯æˆ¿ä¸»)
            </button>
            
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-[#f5f5f7] text-gray-500">æˆ–è€…</span>
                </div>
            </div>

            <div class="flex gap-2">
                <input id="room-code-input" type="number" placeholder="è¾“å…¥æˆ¿ä¸»ç»™çš„æˆ¿é—´å·" class="flex-1 p-4 rounded-2xl border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 font-mono text-center text-lg">
                <button onclick="joinRoom()" class="bg-gray-900 text-white font-semibold px-6 rounded-2xl ios-btn">
                    åŠ å…¥
                </button>
            </div>
        </div>

        <div id="connection-status" class="text-xs text-gray-400 mt-4 h-4"></div>
    </div>

    <!-- Screen 2: Waiting Room -->
    <div id="screen-waiting" class="hidden w-full max-w-md flex-col items-center justify-center h-screen slide-up">
        <div class="ios-card p-8 w-full text-center space-y-6">
            <div class="spinner mx-auto mb-2"></div>
            <h2 class="text-2xl font-bold text-gray-900">ç­‰å¾…å¥½å‹åŠ å…¥...</h2>
            
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                <p class="text-xs text-blue-500 uppercase font-bold mb-1">æˆ¿é—´å·</p>
                <p id="display-room-id" class="text-4xl font-mono font-black text-blue-600 tracking-widest">---</p>
            </div>
            
            <p class="text-sm text-gray-500">å‘Šè¯‰å¯¹æ–¹è¾“å…¥æ­¤å·ç <br><span class="text-xs text-red-400">*æˆ¿ä¸»è¯·å‹¿å…³é—­æ­¤é¡µé¢</span></p>
            <button onclick="location.reload()" class="text-red-500 text-sm font-medium mt-4">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- Screen 3: Setup Phase -->
    <div id="screen-setup" class="hidden w-full max-w-md flex-col h-screen py-6">
        <div class="flex-none mb-4 px-4">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-2xl font-bold text-gray-900">é€‰æ‹©æ¯’è¯</h2>
                <span id="setup-status" class="status-badge bg-yellow-100 text-yellow-700">ç­‰å¾…åŒæ–¹å‡†å¤‡</span>
            </div>
            <p class="text-gray-500 text-sm">ç‚¹å‡»ä¸€é¦–æ­Œè®¾ä¸ºé™·é˜±ï¼Œå¯¹æ–¹ä¸å¯è§</p>
        </div>

        <div class="flex-grow overflow-y-auto px-2 pb-24">
            <div id="setup-grid" class="grid grid-cols-2 gap-3">
                <!-- Grid items generated by JS -->
            </div>
        </div>

        <div class="fixed bottom-6 left-0 right-0 px-6 flex justify-center z-20">
             <button id="confirm-poison-btn" disabled onclick="submitPoison()" class="w-full max-w-md bg-gray-200 text-gray-400 font-bold py-4 rounded-2xl transition-all duration-300 shadow-md">
                è¯·é€‰æ‹©ä¸€é¦–æ­Œ
            </button>
        </div>
    </div>

    <!-- Screen 4: Battle Phase -->
    <div id="screen-battle" class="hidden w-full max-w-md flex-col h-screen py-4">
        <!-- Battle Header -->
        <div class="flex-none mb-4 mx-2 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">å½“å‰çŠ¶æ€</p>
                    <h2 id="battle-status-text" class="text-lg font-bold text-gray-900">å¯¹æ–¹æ­£åœ¨æ€è€ƒ...</h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">å®‰å…¨åŒº</p>
                    <p id="safe-count" class="text-xl font-mono text-green-500 font-bold">16</p>
                </div>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-1.5">
                <div id="turn-indicator" class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: 50%"></div>
            </div>
        </div>

        <!-- Battle Grid -->
        <div class="flex-grow overflow-y-auto px-2 pb-6">
            <div id="battle-grid" class="grid grid-cols-2 gap-3">
                <!-- Battle items generated by JS -->
            </div>
        </div>
    </div>

    <!-- Screen 5: Game Over -->
    <div id="screen-result" class="hidden w-full max-w-md text-center slide-up z-50 fixed inset-0 bg-white/95 backdrop-blur-xl flex flex-col justify-center items-center p-6">
        <div class="w-full max-w-sm">
            <div id="result-icon" class="text-7xl mb-6">ğŸ†</div>
            <h2 id="result-title" class="text-4xl font-black text-gray-900 mb-2">èƒœåˆ©!</h2>
            <p id="result-desc" class="text-xl text-gray-500 mb-8">å¯¹æ–¹å–ä¸‹äº†æ¯’è¯</p>
            
            <div class="bg-gray-50 p-6 rounded-2xl mb-8 border border-gray-100">
                <p class="text-xs text-gray-400 uppercase mb-2 font-bold tracking-widest">è‡´å‘½æ¯’è¯</p>
                <p id="result-poison-name" class="text-2xl font-bold text-gray-900">---</p>
            </div>

            <div class="mb-10">
                <div class="inline-block px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold mb-3">
                    æƒ©ç½šæ—¶é—´
                </div>
                <div id="result-punishment" class="text-gray-800 text-lg font-medium px-4">
                    ---
                </div>
            </div>

            <button onclick="location.reload()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg ios-btn text-lg">
                è¿”å›å¤§å…
            </button>
        </div>
    </div>

    <script>
        const SONG_LIBRARY = [
            "ä¸ƒé‡Œé¦™", "å­¤å‹‡è€…", "æˆéƒ½", "æ¼”å‘˜", "åæ¥", "æ™´å¤©", "åå¹´", "ç¨»é¦™", "ç®€å•çˆ±", "å‘Šç™½æ°”çƒ", "ä½“é¢", "å‡‰å‡‰", "é€†æˆ˜", "æ³¡æ²«", "é‡è§", "å°å¹¸è¿",
            "é’èŠ±ç“·", "æœ¬è‰çº²ç›®", "é¾™å·é£", "ææµ…", "å®‰é™", "å¬å¦ˆå¦ˆçš„è¯", "åƒé‡Œä¹‹å¤–", "èŠèŠ±å°", "å¤œæ›²", "å½©è™¹", "å‘å¦‚é›ª", "ç”œç”œçš„", "è’²å…¬è‹±çš„çº¦å®š", "æœ€é•¿çš„ç”µå½±",
            "æ±Ÿå—", "ä¸€åƒå¹´ä»¥å", "æ›¹æ“", "å°é…’çª", "ä¿®ç‚¼çˆ±æƒ…", "å¯æƒœæ²¡å¦‚æœ", "ä¸ä¸ºè°è€Œä½œçš„æ­Œ", "èƒŒå¯¹èƒŒæ‹¥æŠ±", "å¥¹è¯´", "ç¬¬å‡ ä¸ª100å¤©",
            "ç«¥è¯", "å‹‡æ°”", "æš–æš–", "åˆ†æ‰‹å¿«ä¹", "å´‡æ‹œ", "ç‡•å°¾è¶", "å®å¤", "æƒ…æ­Œ", "å¯æƒœä¸æ˜¯ä½ ", "ä¼šå‘¼å¸çš„ç—›",
            "å”¯ä¸€", "ä¾ç„¶çˆ±ä½ ", "å¤§åŸå°çˆ±", "æ”¹å˜è‡ªå·±", "å¿ƒä¸­çš„æ—¥æœˆ", "èŠ±ç”°é”™", "æˆ‘ä»¬çš„æ­Œ", "éœ€è¦äººé™ª", "ä½ ä¸çŸ¥é“çš„äº‹",
            "å»åˆ«", "ä¸€è·¯ä¸Šæœ‰ä½ ", "é¥è¿œçš„å¥¹", "æ¯å¤©çˆ±ä½ å¤šä¸€äº›", "é¥¿ç‹¼ä¼ è¯´", "å¤´å‘ä¹±äº†", "æ…¢æ…¢", "åªæƒ³ä¸€ç”Ÿè·Ÿä½ èµ°",
            "æµ·é˜”å¤©ç©º", "å…‰è¾‰å²æœˆ", "çœŸçš„çˆ±ä½ ", "ä¸å†çŠ¹è±«", "å–œæ¬¢ä½ ", "æƒ…äºº", "å¤§åœ°", "Amani",
            "çº¢è±†", "åŒ†åŒ†é‚£å¹´", "å› ä¸ºçˆ±æƒ…", "å®¹æ˜“å—ä¼¤çš„å¥³äºº", "æµå¹´", "ä¼ å¥‡", "äººé—´", "ç¬‘å¿˜ä¹¦",
            "å¤§é±¼", "èµ·é£äº†", "æ¶ˆæ„", "åƒæˆ‘è¿™æ ·çš„äºº", "å¹³å‡¡ä¹‹è·¯", "å—å±±å—", "å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ", "è¿½æ¢¦èµ¤å­å¿ƒ", "è“è²èŠ±", "æ›¾ç»çš„ä½ ",
            "ä¸å¾—ä¸çˆ±", "å¿«ä¹å´‡æ‹œ", "å£è™æ¼«æ­¥", "æˆ‘çš„éº¦å…‹é£", "åè½¬åœ°çƒ", "æ½˜æœµæ‹‰", "å¯“è¨€", "é—å¤±çš„ç¾å¥½", "éšå½¢çš„ç¿…è†€", "æ¬§è‹¥æ‹‰",
            "Super Star", "æ³¢æ–¯çŒ«", "ä¸æƒ³é•¿å¤§", "ä¸­å›½è¯", "Shero", "ç—›å¿«", "æ‹äººæœªæ»¡", "çƒ­å¸¦é›¨æ—",
            "æ—¥ä¸è½", "å€’å¸¦", "å¸ƒæ‹‰æ ¼å¹¿åœº", "èˆå¨˜", "ç‰¹åŠ¡J", "çˆ±æƒ…ä¸‰åå…­è®¡", "ä»Šå¤©ä½ è¦å«ç»™æˆ‘", "è¯´çˆ±ä½ ",
            "å½“ä½ ", "çˆ±ä½ ", "ç«æ¯›å¼¯å¼¯", "ç¬¬ä¸€æ¬¡çˆ±çš„äºº", "é‚£å¹´å¤å¤©", "æ¬§è‹¥æ‹‰", "æ·‹é›¨ä¸€ç›´èµ°",
            "å¹´å°‘æœ‰ä¸º", "æç™½", "æ¨¡ç‰¹", "å–œå‰§ä¹‹ç‹", "ä¸å°†å°±", "æˆ’çƒŸ", "éº»é›€", "è€è¡—"
        ];
        
        const PUNISHMENTS = [
            "æ·±æƒ…æ¼”å”±è¿™é¦–æ­Œçš„å‰¯æ­Œ (30ç§’)", "æ¨¡ä»¿åŸå”±çš„ç»å…¸åŠ¨ä½œæ‹ç…§", "çœŸå¿ƒè¯ï¼šè¯´å‡ºä½ ç°åœ¨çš„å±ä¿æ˜¯è°", "ç”¨æ–¹è¨€æœ—è¯»è¿™é¦–æ­Œçš„æ­Œè¯",
            "å‘ä¸ªçº¢åŒ…ç»™èµ¢å®¶ (é‡‘é¢éšæ„)", "åš5ä¸ªæ·±è¹²å¹¶ä¸€è¾¹å”±è¿™é¦–æ­Œ", "è®©èµ¢å®¶åœ¨ä½ çš„è„¸ä¸Šç”»ä¸€ä¸ªå°å›¾æ¡ˆ", "å¤§å–Šä¸‰å£°ï¼šæˆ‘æ˜¯éº¦éœ¸ï¼"
        ];

        // --- P2P Global State ---
        let peer = null;
        let conn = null;
        let myRole = null; // 'host' or 'guest'
        let localPoisonSelection = null;
        
        // The Host maintains the 'True' game state
        let gameState = {
            status: 'waiting',
            songs: [],
            p1Poison: null, // Host Poison
            p2Poison: null, // Guest Poison
            sungSongs: [],
            currentTurn: 'host', // 'host' or 'guest'
            winner: null,
            punishment: ''
        };

        // --- UI Functions ---
        function showScreen(name) {
            ['lobby', 'waiting', 'setup', 'battle', 'result'].forEach(id => {
                document.getElementById(`screen-${id}`).classList.add('hidden');
            });
            document.getElementById(`screen-${name}`).classList.remove('hidden');
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function log(msg) {
            console.log(msg);
            document.getElementById('connection-status').innerText = msg;
        }

        // --- P2P Logic ---

        function createRoom() {
            // Generate a random 6-digit room ID
            const roomId = Math.floor(Math.random() * 900000 + 100000).toString();
            // Prefix to avoid collision with other apps using public PeerJS server
            const peerId = 'witch_game_' + roomId; 

            log("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...");
            
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                log("åˆ›å»ºæˆåŠŸï¼");
                myRole = 'host';
                document.getElementById('display-room-id').innerText = roomId;
                showScreen('waiting');

                // Init Game State
                gameState.songs = shuffle([...SONG_LIBRARY]).slice(0, 16);
                gameState.songs = shuffle(gameState.songs);
                gameState.punishment = PUNISHMENTS[Math.floor(Math.random() * PUNISHMENTS.length)];
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
                // Move to setup
                gameState.status = 'setup';
                syncState();
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    alert("æˆ¿é—´å·ç”Ÿæˆå†²çªï¼Œè¯·é‡è¯•");
                    location.reload();
                } else {
                    alert("è¿æ¥é”™è¯¯: " + err.type);
                }
            });
        }

        function joinRoom() {
            const input = document.getElementById('room-code-input');
            const roomId = input.value.trim();
            if (roomId.length !== 6) { alert("è¯·è¾“å…¥6ä½æˆ¿é—´å·"); return; }

            const peerId = 'witch_game_' + roomId;
            log("æ­£åœ¨æŸ¥æ‰¾æˆ¿é—´...");

            peer = new Peer(); // Guest gets random ID

            peer.on('open', () => {
                conn = peer.connect(peerId);
                if(!conn) { alert("æ— æ³•è¿æ¥"); return; }
                
                myRole = 'guest';
                setupConnection();
            });

            peer.on('error', (err) => {
                alert("æ— æ³•è¿æ¥åˆ°æˆ¿é—´ï¼Œå¯èƒ½æˆ¿é—´å·é”™è¯¯æˆ–æˆ¿ä¸»å·²ç¦»çº¿");
            });
        }

        function setupConnection() {
            conn.on('open', () => {
                log("å·²è¿æ¥ï¼");
            });

            conn.on('data', (data) => {
                // If I am Guest, I receive State from Host
                if (myRole === 'guest' && data.type === 'SYNC') {
                    gameState = data.state;
                    renderGame();
                }
                // If I am Host, I receive Actions from Guest
                if (myRole === 'host' && data.type === 'ACTION') {
                    handleGuestAction(data.payload);
                }
            });

            conn.on('close', () => {
                alert("å¯¹æ–¹å·²æ–­å¼€è¿æ¥");
                location.reload();
            });
        }

        // Only Host calls this to push state to Guest
        function syncState() {
            renderGame(); // Render local
            if (conn && conn.open) {
                conn.send({ type: 'SYNC', state: gameState });
            }
        }

        // --- Game Logic (Host controls everything) ---

        function handleGuestAction(payload) {
            if (payload.action === 'SET_POISON') {
                gameState.p2Poison = payload.index;
                checkSetupComplete();
            }
            if (payload.action === 'CLICK_SONG') {
                processTurn(payload.index);
            }
            syncState();
        }

        // Local actions (Host or Guest UI triggers this)
        function submitPoison() {
            if (localPoisonSelection === null) return;

            if (myRole === 'host') {
                gameState.p1Poison = localPoisonSelection;
                checkSetupComplete();
                syncState();
            } else {
                // Send choice to host
                conn.send({ type: 'ACTION', payload: { action: 'SET_POISON', index: localPoisonSelection } });
                // We optimistically disable button locally in render
                // But actual state update waits for sync
            }
            
            // Disable button visually immediately
            document.getElementById('confirm-poison-btn').innerText = "ç­‰å¾…å¯¹æ–¹...";
            document.getElementById('confirm-poison-btn').disabled = true;
        }

        function checkSetupComplete() {
            if (gameState.p1Poison !== null && gameState.p2Poison !== null) {
                gameState.status = 'battle';
            }
        }

        function handleBattleClick(index) {
            if (myRole === 'host') {
                processTurn(index);
                syncState();
            } else {
                conn.send({ type: 'ACTION', payload: { action: 'CLICK_SONG', index: index } });
            }
        }

        function processTurn(index) {
            // Core Logic (Run on Host)
            if (gameState.sungSongs.includes(index)) return;

            const currentActor = gameState.currentTurn; // 'host' or 'guest'
            const opponentPoison = currentActor === 'host' ? gameState.p2Poison : gameState.p1Poison;
            const myPoison = currentActor === 'host' ? gameState.p1Poison : gameState.p2Poison;

            if (index === opponentPoison) {
                // Stepped on poison -> Current actor loses
                gameState.status = 'gameover';
                gameState.winner = currentActor === 'host' ? 'guest' : 'host';
                gameState.sungSongs.push(index);
            } else {
                // Safe
                gameState.sungSongs.push(index);
                gameState.currentTurn = currentActor === 'host' ? 'guest' : 'host';
            }
        }


        // --- Render Logic ---

        function renderGame() {
            if (gameState.status === 'setup') {
                showScreen('setup');
                renderSetup();
            } else if (gameState.status === 'battle') {
                showScreen('battle');
                renderBattle();
            } else if (gameState.status === 'gameover') {
                showScreen('result');
                renderResult();
            }
        }

        function renderSetup() {
            const isMeReady = myRole === 'host' ? gameState.p1Poison !== null : gameState.p2Poison !== null;
            const isOpponentReady = myRole === 'host' ? gameState.p2Poison !== null : gameState.p1Poison !== null;

            const statusBadge = document.getElementById('setup-status');
            if (isMeReady && !isOpponentReady) {
                statusBadge.innerText = "ç­‰å¾…å¯¹æ–¹...";
                statusBadge.className = "status-badge bg-blue-100 text-blue-700 animate-pulse";
            } else if (!isMeReady) {
                statusBadge.innerText = "è¯·é€‰æ‹©";
                statusBadge.className = "status-badge bg-yellow-100 text-yellow-700";
            }

            const grid = document.getElementById('setup-grid');
            // Init grid if empty
            if (grid.children.length === 0) {
                gameState.songs.forEach((song, index) => {
                    const btn = document.createElement('button');
                    btn.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-gray-800 font-medium h-16 flex items-center justify-between transition-all active:scale-95";
                    btn.onclick = () => {
                        localPoisonSelection = index;
                        // Reset all
                        Array.from(grid.children).forEach(b => {
                            b.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-gray-800 font-medium h-16 flex items-center justify-between transition-all active:scale-95";
                            b.querySelector('span:last-child').innerHTML = 'ğŸµ';
                            b.querySelector('span:last-child').className = "text-xl opacity-30";
                        });
                        // Highlight
                        btn.className = "bg-blue-50 p-4 rounded-xl shadow-inner border-2 border-blue-500 text-blue-800 font-bold h-16 flex items-center justify-between transform scale-[0.98]";
                        btn.querySelector('span:last-child').innerHTML = 'â˜ ï¸';
                        btn.querySelector('span:last-child').className = "text-xl";

                        const cBtn = document.getElementById('confirm-poison-btn');
                        cBtn.disabled = false;
                        cBtn.className = "w-full max-w-md bg-[#0071e3] hover:bg-[#0077ED] text-white font-bold py-4 rounded-2xl transition-all duration-300 shadow-lg";
                        cBtn.innerText = "ç¡®è®¤ä¸‹æ¯’";
                    };
                    btn.innerHTML = `<span class="truncate text-sm">${song}</span><span class="text-xl opacity-30">ğŸµ</span>`;
                    grid.appendChild(btn);
                });
            }

            if (isMeReady) {
                 const cBtn = document.getElementById('confirm-poison-btn');
                 cBtn.innerText = "å·²ç¡®è®¤ï¼Œç­‰å¾…å¯¹æ–¹...";
                 cBtn.disabled = true;
                 cBtn.className = "w-full max-w-md bg-green-500 text-white font-bold py-4 rounded-2xl shadow-md";
            }
        }

        function renderBattle() {
            const isMyTurn = gameState.currentTurn === myRole;
            const statusText = document.getElementById('battle-status-text');
            const turnIndicator = document.getElementById('turn-indicator');
            const safeCount = document.getElementById('safe-count');

            if (isMyTurn) {
                statusText.innerText = "è½®åˆ°ä½ äº†ï¼è¯·ç‚¹æ­Œ";
                statusText.className = "text-lg font-bold text-[#0071e3] animate-pulse";
                turnIndicator.className = "bg-[#0071e3] h-1.5 rounded-full transition-all duration-500";
            } else {
                statusText.innerText = "å¯¹æ–¹æ­£åœ¨æ€è€ƒ...";
                statusText.className = "text-lg font-bold text-gray-500";
                turnIndicator.className = "bg-gray-300 h-1.5 rounded-full transition-all duration-500";
            }
            safeCount.innerText = 16 - gameState.sungSongs.length;

            const grid = document.getElementById('battle-grid');
            grid.innerHTML = '';
            gameState.songs.forEach((song, index) => {
                const isSung = gameState.sungSongs.includes(index);
                const btn = document.createElement('button');
                
                if (isSung) {
                     btn.className = "h-20 p-2 rounded-xl text-sm relative flex flex-col items-center justify-center font-bold shadow-sm bg-gray-100 border border-gray-200 text-gray-400 opacity-60 cursor-not-allowed";
                     btn.disabled = true;
                     btn.innerHTML = `<span class="line-through">${song}</span>`;
                } else {
                     if (isMyTurn) {
                        btn.className = "h-20 p-2 rounded-xl text-sm relative transition-all duration-300 flex flex-col items-center justify-center font-bold shadow-sm bg-white border border-gray-100 text-gray-800 hover:shadow-md active:scale-95 active:bg-gray-50";
                        btn.onclick = () => handleBattleClick(index);
                     } else {
                        btn.className = "h-20 p-2 rounded-xl text-sm relative flex flex-col items-center justify-center font-bold shadow-sm bg-white border border-gray-100 text-gray-800 opacity-80 cursor-wait";
                        btn.disabled = true;
                     }
                     btn.innerHTML = `<span class="z-10">${song}</span><div class="absolute bottom-1 right-2 text-gray-200 text-xs">ğŸ¤</div>`;
                }
                grid.appendChild(btn);
            });
        }

        function renderResult() {
            const isWinner = gameState.winner === myRole;
            const poisonIndex = gameState.winner === 'host' ? gameState.p2Poison : gameState.p1Poison;
            // The poison that killed the loser is the WINNER'S poison.
            // Eg. Host wins -> Guest lost -> Guest clicked Host's poison.
            const fatalIndex = gameState.winner === 'host' ? gameState.p1Poison : gameState.p2Poison;

            document.getElementById('result-poison-name').innerText = `ğŸµ ${gameState.songs[fatalIndex]}`;
            document.getElementById('result-punishment').innerText = gameState.punishment;

            const icon = document.getElementById('result-icon');
            const title = document.getElementById('result-title');
            const desc = document.getElementById('result-desc');

            if (isWinner) {
                icon.innerText = "ğŸ†";
                title.innerText = "èƒœåˆ©!";
                title.className = "text-4xl font-black text-[#0071e3] mb-2";
                desc.innerText = "å¯¹æ–¹å–ä¸‹äº†ä½ è®¾çš„æ¯’è¯";
            } else {
                icon.innerText = "ğŸ’¥";
                title.innerText = "å¤±è´¥!";
                title.className = "text-4xl font-black text-red-500 mb-2";
                desc.innerText = "ä½ å–ä¸‹äº†å¯¹æ–¹çš„æ¯’è¯...";
            }
        }
    </script>
</body>
</html>