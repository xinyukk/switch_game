<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥³å·«çš„æ¯’è¯ - å¤šä¸»é¢˜ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS (å›½å†… BootCDN åŠ é€Ÿ) -->
    <script src="https://cdn.bootcdn.net/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1d1d1f;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            min-height: 100vh;
        }

        .ios-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: saturate(180%) blur(20px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .ios-btn {
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .ios-btn:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinner {
            border: 3px solid rgba(0, 113, 227, 0.1);
            border-left-color: #0071e3;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Emote Animations */
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            80% { transform: translateY(-80px) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.8); opacity: 0; }
        }
        .emote-float {
            position: fixed;
            bottom: 100px;
            left: 50%;
            font-size: 4rem;
            pointer-events: none;
            z-index: 100;
            margin-left: -2rem;
            animation: floatUp 2s ease-out forwards;
        }
        
        /* Category Card Styles */
        .category-card {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .category-card:hover::before {
            opacity: 1;
        }
        
        .category-card.selected {
            transform: scale(0.95);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
        }
        
        /* Icon animation */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .icon-bounce {
            animation: bounce 2s infinite;
        }
        
        /* Theme backgrounds */
        .theme-music { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .theme-food { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .theme-city { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .theme-sports { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .theme-movie { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .theme-tech { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        
        @media (min-width: 641px) {
            .grid-cols-2 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        
        /* Poison marker styles */
        .poison-marker {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            z-index: 10;
        }
        
        .my-poison {
            background-color: #ef4444;
        }
        
        .opponent-poison {
            background-color: #8b5cf6;
        }
        
        .both-poison {
            background-color: #f59e0b;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Emote Overlay Container -->
    <div id="emote-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Screen 1: Connect Room -->
    <div id="screen-connect" class="w-full max-w-md space-y-6 slide-up text-center">
        <div class="pt-8 pb-4">
            <h1 class="text-4xl font-extrabold tracking-tight text-white mb-2">å¥³å·«çš„æ¯’è¯</h1>
            <p class="text-white/80 text-sm font-medium tracking-wide">åˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´å¼€å§‹æ¸¸æˆ</p>
        </div>

        <div class="ios-card p-6 space-y-4">
            <button onclick="createRoom()" class="w-full bg-[#0071e3] hover:bg-[#0077ED] text-white font-semibold py-5 px-8 rounded-2xl shadow-lg ios-btn flex items-center justify-center gap-3">
                <span>ğŸ </span> åˆ›å»ºæˆ¿é—´ (æˆ‘æ˜¯æˆ¿ä¸»)
            </button>
            
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">æˆ–è€…</span>
                </div>
            </div>

            <div class="flex gap-2">
                <input id="room-code-input" type="number" placeholder="è¾“å…¥æˆ¿ä¸»ç»™çš„æˆ¿é—´å·" class="flex-1 p-4 rounded-2xl border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 font-mono text-center text-lg">
                <button onclick="joinRoom()" class="bg-gray-900 text-white font-semibold px-6 rounded-2xl ios-btn">
                    åŠ å…¥
                </button>
            </div>
        </div>

        <div id="connection-status" class="text-xs text-white/70 mt-4 h-4"></div>
    </div>

    <!-- Screen 2: Category Selection -->
    <div id="screen-category" class="hidden w-full max-w-md space-y-6 slide-up text-center">
        <div class="ios-card p-6">
            <div class="flex items-center justify-between mb-4">
                <button onclick="disconnectRoom()" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <div class="text-center">
                    <h2 class="text-lg font-bold text-gray-800">é€‰æ‹©ä¸»é¢˜</h2>
                </div>
                <div class="w-6"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div onclick="selectCategory('music')" class="category-card ios-card p-6 text-center" data-category="music">
                    <div class="text-4xl mb-2">ğŸµ</div>
                    <h3 class="font-bold text-gray-800">æµè¡ŒéŸ³ä¹</h3>
                    <p class="text-xs text-gray-500 mt-1">ç»å…¸åè¯­æ­Œæ›²</p>
                </div>
                
                <div onclick="selectCategory('food')" class="category-card ios-card p-6 text-center" data-category="food">
                    <div class="text-4xl mb-2">ğŸœ</div>
                    <h3 class="font-bold text-gray-800">ç¾é£Ÿå¤©åœ°</h3>
                    <p class="text-xs text-gray-500 mt-1">ä¸­å¤–ç¾é£Ÿæ–™ç†</p>
                </div>
                
                <div onclick="selectCategory('city')" class="category-card ios-card p-6 text-center" data-category="city">
                    <div class="text-4xl mb-2">ğŸ™ï¸</div>
                    <h3 class="font-bold text-gray-800">ä¸–ç•ŒåŸå¸‚</h3>
                    <p class="text-xs text-gray-500 mt-1">çŸ¥ååŸå¸‚åœ°æ ‡</p>
                </div>
                
                <div onclick="selectCategory('sports')" class="category-card ios-card p-6 text-center" data-category="sports">
                    <div class="text-4xl mb-2">âš½</div>
                    <h3 class="font-bold text-gray-800">ä½“è‚²è¿åŠ¨</h3>
                    <p class="text-xs text-gray-500 mt-1">çƒ­é—¨è¿åŠ¨é¡¹ç›®</p>
                </div>
                
                <div onclick="selectCategory('movie')" class="category-card ios-card p-6 text-center" data-category="movie">
                    <div class="text-4xl mb-2">ğŸ¬</div>
                    <h3 class="font-bold text-gray-800">å½±è§†ä½œå“</h3>
                    <p class="text-xs text-gray-500 mt-1">ç»å…¸ç”µå½±å‰§é›†</p>
                </div>
                
                <div onclick="selectCategory('tech')" class="category-card ios-card p-6 text-center" data-category="tech">
                    <div class="text-4xl mb-2">ğŸ’»</div>
                    <h3 class="font-bold text-gray-800">ç§‘æŠ€æ•°ç </h3>
                    <p class="text-xs text-gray-500 mt-1">ç§‘æŠ€äº§å“å“ç‰Œ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen 3: Waiting Room -->
    <div id="screen-waiting" class="hidden w-full max-w-md flex-col items-center justify-center h-screen slide-up">
        <div class="ios-card p-8 w-full text-center space-y-6">
            <div class="spinner mx-auto mb-2"></div>
            <h2 class="text-2xl font-bold text-gray-900">ç­‰å¾…å¥½å‹åŠ å…¥...</h2>
            
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                <p class="text-xs text-blue-500 uppercase font-bold mb-1">æˆ¿é—´å·</p>
                <p id="display-room-id" class="text-4xl font-mono font-black text-blue-600 tracking-widest">---</p>
            </div>
            
            <p class="text-sm text-gray-500">å‘Šè¯‰å¯¹æ–¹è¾“å…¥æ­¤å·ç <br><span class="text-xs text-red-400">*æˆ¿ä¸»è¯·å‹¿å…³é—­æ­¤é¡µé¢</span></p>
        </div>
    </div>

    <!-- Screen 4: Setup Phase -->
    <div id="screen-setup" class="hidden w-full max-w-md flex-col h-screen py-6">
        <div class="flex-none mb-4 px-4">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-2xl font-bold text-gray-900">é€‰æ‹©æ¯’è¯</h2>
                <span id="setup-status" class="status-badge bg-yellow-100 text-yellow-700">ç­‰å¾…åŒæ–¹å‡†å¤‡</span>
            </div>
            <p class="text-gray-500 text-sm">ç‚¹å‡»ä¸€ä¸ªé€‰é¡¹è®¾ä¸ºé™·é˜±ï¼Œå¯¹æ–¹ä¸å¯è§</p>
        </div>

        <div class="flex-grow overflow-y-auto px-2 pb-24">
            <div id="setup-grid" class="grid grid-cols-2 gap-3">
                <!-- Grid items generated by JS -->
            </div>
        </div>

        <div class="fixed bottom-6 left-0 right-0 px-6 flex justify-center z-20">
             <button id="confirm-poison-btn" disabled onclick="submitPoison()" class="w-full max-w-md bg-gray-200 text-gray-400 font-bold py-4 rounded-2xl transition-all duration-300 shadow-md">
                è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹
            </button>
        </div>
    </div>

    <!-- Screen 5: Battle Phase -->
    <div id="screen-battle" class="hidden w-full max-w-md flex-col h-screen py-4 relative">
        <!-- Battle Header -->
        <div class="flex-none mb-4 mx-2 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">å½“å‰çŠ¶æ€</p>
                    <h2 id="battle-status-text" class="text-lg font-bold text-gray-900">å¯¹æ–¹æ­£åœ¨æ€è€ƒ...</h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">å®‰å…¨åŒº</p>
                    <p id="safe-count" class="text-xl font-mono text-green-500 font-bold">16</p>
                </div>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-1.5">
                <div id="turn-indicator" class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: 50%"></div>
            </div>
        </div>

        <!-- Battle Grid -->
        <div class="flex-grow overflow-y-auto px-2 pb-20">
            <div id="battle-grid" class="grid grid-cols-2 gap-3">
                <!-- Battle items generated by JS -->
            </div>
        </div>

        <!-- Emote Bar -->
        <div class="fixed bottom-6 left-0 right-0 px-4 flex justify-center z-20">
            <div class="bg-white/90 backdrop-blur shadow-xl border border-gray-200 rounded-full px-4 py-2 flex gap-4">
                <button onclick="sendEmote('ğŸ˜±')" class="text-2xl hover:scale-125 transition-transform">ğŸ˜±</button>
                <button onclick="sendEmote('ğŸ¤”')" class="text-2xl hover:scale-125 transition-transform">ğŸ¤”</button>
                <button onclick="sendEmote('ğŸ¤£')" class="text-2xl hover:scale-125 transition-transform">ğŸ¤£</button>
                <button onclick="sendEmote('ğŸ«£')" class="text-2xl hover:scale-125 transition-transform">ğŸ«£</button>
                <button onclick="sendEmote('ğŸ˜¡')" class="text-2xl hover:scale-125 transition-transform">ğŸ˜¡</button>
            </div>
        </div>
    </div>

    <!-- Screen 6: Game Over / Review -->
    <div id="screen-result" class="hidden w-full max-w-md text-center slide-up z-50 fixed inset-0 bg-gradient-to-br from-purple-500 to-pink-500 flex flex-col h-screen overflow-hidden">
        <!-- Result Header (Fixed) -->
        <div class="flex-none p-6 pb-2 bg-white/90 backdrop-blur shadow-sm z-10">
            <div id="result-icon" class="text-6xl mb-2">ğŸ†</div>
            <h2 id="result-title" class="text-3xl font-black text-gray-900 mb-1">èƒœåˆ©!</h2>
            <p id="result-desc" class="text-lg text-gray-500">å¯¹æ–¹è¸©ä¸­äº†é™·é˜±</p>
            
            <div id="both-poison-info" class="hidden mt-2 p-2 bg-amber-50 rounded-lg border border-amber-200">
                <p class="text-sm text-amber-800 font-medium">åŒæ–¹é€‰æ‹©äº†ç›¸åŒçš„æ¯’è¯ï¼</p>
            </div>
            
            <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-xl p-3">
                <span class="text-xs font-bold text-yellow-700 uppercase">æƒ©ç½š</span>
                <p id="result-punishment" class="text-gray-900 font-medium">---</p>
            </div>
        </div>

        <!-- Review Grid (Scrollable) -->
        <div class="flex-grow overflow-y-auto p-4">
            <div class="flex items-center justify-between mb-2 px-2">
                <h3 class="text-sm font-bold text-white/80 uppercase tracking-wider">æˆ˜å±€å¤ç›˜</h3>
                <div class="flex gap-3 text-xs">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500"></span>æˆ‘çš„é™·é˜±</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-purple-500"></span>TAçš„é™·é˜±</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-amber-500"></span>å…±åŒé™·é˜±</div>
                </div>
            </div>
            <div id="review-grid" class="grid grid-cols-4 gap-2 opacity-90">
                <!-- Review items generated by JS -->
            </div>
        </div>

        <!-- Footer Actions (Fixed) -->
        <div class="flex-none p-4 bg-white/90 backdrop-blur space-y-2">
            <button onclick="requestRematch()" id="rematch-btn" class="w-full bg-[#0071e3] hover:bg-[#0077ED] text-white font-bold py-4 rounded-2xl shadow-lg ios-btn text-lg flex items-center justify-center gap-2">
                <span>ğŸ”„</span> å†æ¥ä¸€å±€
            </button>
            <button onclick="disconnectRoom()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-2xl shadow-md ios-btn">
                é€€å‡ºæˆ¿é—´
            </button>
        </div>
    </div>

    <script>
        // æ‰©å±•é¢˜åº“ - å¤šç±»åˆ«
        const CATEGORY_LIBRARIES = {
            music: {
                name: "æµè¡ŒéŸ³ä¹",
                icon: "ğŸµ",
                theme: "theme-music",
                items: [
                    "ä¸ƒé‡Œé¦™", "å­¤å‹‡è€…", "æˆéƒ½", "æ¼”å‘˜", "åæ¥", "æ™´å¤©", "åå¹´", "ç¨»é¦™", "ç®€å•çˆ±", "å‘Šç™½æ°”çƒ", 
                    "ä½“é¢", "å‡‰å‡‰", "é€†æˆ˜", "æ³¡æ²«", "é‡è§", "å°å¹¸è¿", "é’èŠ±ç“·", "æœ¬è‰çº²ç›®", "é¾™å·é£", "ææµ…",
                    "å®‰é™", "å¬å¦ˆå¦ˆçš„è¯", "åƒé‡Œä¹‹å¤–", "èŠèŠ±å°", "å¤œæ›²", "å½©è™¹", "å‘å¦‚é›ª", "ç”œç”œçš„", "è’²å…¬è‹±çš„çº¦å®š", "æœ€é•¿çš„ç”µå½±",
                    "æ±Ÿå—", "ä¸€åƒå¹´ä»¥å", "æ›¹æ“", "å°é…’çª", "ä¿®ç‚¼çˆ±æƒ…", "å¯æƒœæ²¡å¦‚æœ", "ä¸ä¸ºè°è€Œä½œçš„æ­Œ", "èƒŒå¯¹èƒŒæ‹¥æŠ±", "å¥¹è¯´", "ç¬¬å‡ ä¸ª100å¤©",
                    "ç«¥è¯", "å‹‡æ°”", "æš–æš–", "åˆ†æ‰‹å¿«ä¹", "å´‡æ‹œ", "ç‡•å°¾è¶", "å®å¤", "æƒ…æ­Œ", "å¯æƒœä¸æ˜¯ä½ ", "ä¼šå‘¼å¸çš„ç—›",
                    "å”¯ä¸€", "ä¾ç„¶çˆ±ä½ ", "å¤§åŸå°çˆ±", "æ”¹å˜è‡ªå·±", "å¿ƒä¸­çš„æ—¥æœˆ", "èŠ±ç”°é”™", "æˆ‘ä»¬çš„æ­Œ", "éœ€è¦äººé™ª", "ä½ ä¸çŸ¥é“çš„äº‹",
                    "å»åˆ«", "ä¸€è·¯ä¸Šæœ‰ä½ ", "é¥è¿œçš„å¥¹", "æ¯å¤©çˆ±ä½ å¤šä¸€äº›", "é¥¿ç‹¼ä¼ è¯´", "å¤´å‘ä¹±äº†", "æ…¢æ…¢", "åªæƒ³ä¸€ç”Ÿè·Ÿä½ èµ°",
                    "æµ·é˜”å¤©ç©º", "å…‰è¾‰å²æœˆ", "çœŸçš„çˆ±ä½ ", "ä¸å†çŠ¹è±«", "å–œæ¬¢ä½ ", "æƒ…äºº", "å¤§åœ°", "Amani",
                    "çº¢è±†", "åŒ†åŒ†é‚£å¹´", "å› ä¸ºçˆ±æƒ…", "å®¹æ˜“å—ä¼¤çš„å¥³äºº", "æµå¹´", "ä¼ å¥‡", "äººé—´", "ç¬‘å¿˜ä¹¦",
                    "å¤§é±¼", "èµ·é£äº†", "æ¶ˆæ„", "åƒæˆ‘è¿™æ ·çš„äºº", "å¹³å‡¡ä¹‹è·¯", "å—å±±å—", "å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ", "è¿½æ¢¦èµ¤å­å¿ƒ", "è“è²èŠ±", "æ›¾ç»çš„ä½ "
                ]
            },
            food: {
                name: "ç¾é£Ÿå¤©åœ°",
                icon: "ğŸœ",
                theme: "theme-food",
                items: [
                    "åŒ—äº¬çƒ¤é¸­", "éº»å©†è±†è…", "å®«ä¿é¸¡ä¸", "é±¼é¦™è‚‰ä¸", "å›é”…è‚‰", "æ°´ç…®é±¼", "ç«é”…", "å°ç¬¼åŒ…", "ç…é¥¼æœå­", "è‚‰å¤¹é¦",
                    "å…°å·æ‹‰é¢", "åˆ€å‰Šé¢", "ç‚¸é…±é¢", "çƒ­å¹²é¢", "æ‹…æ‹…é¢", "è¿‡æ¡¥ç±³çº¿", "èºè›³ç²‰", "æ¡‚æ—ç±³ç²‰", "æ²™å¿å°åƒ", "é»„ç„–é¸¡",
                    "å¯¿å¸", "æ‹‰é¢", "å¤©å¦‡ç½—", "åˆºèº«", "ç« é±¼çƒ§", "å¤§é˜ªçƒ§", "çƒ¤è‚‰", "æ³¡èœ", "çŸ³é”…æ‹Œé¥­", "éƒ¨é˜Ÿé”…",
                    "æŠ«è¨", "æ„å¤§åˆ©é¢", "ç„—é¥­", "ç‰›æ’", "æ±‰å ¡", "çƒ­ç‹—", "è–¯æ¡", "æ²™æ‹‰", "ä¸‰æ˜æ²»", "å¯é¢‚",
                    "ææ‹‰ç±³è‹", "é©¬å¡é¾™", "èŠå£«è›‹ç³•", "æ…•æ–¯", "å¸ƒæœ—å°¼", "æ›²å¥‡", "æ³¡èŠ™", "ç”œç”œåœˆ", "åå¤«é¥¼", "æ¾é¥¼",
                    "çç å¥¶èŒ¶", "å’–å•¡", "æœæ±", "å¯ä¹", "å•¤é…’", "çº¢é…’", "æ¸…é…’", "å¨å£«å¿Œ", "é¸¡å°¾é…’", "èŒ¶",
                    "å°é¾™è™¾", "å¤§é—¸èŸ¹", "çƒ¤ä¸²", "éº»è¾£çƒ«", "ä¸²ä¸²é¦™", "å†’èœ", "é’µé’µé¸¡", "çƒ¤é±¼", "é…¸èœé±¼", "æ¯›è¡€æ—º",
                    "è›‹ç‚’é¥­", "æ‰¬å·ç‚’é¥­", "ç…²ä»”é¥­", "å’–å–±é¥­", "ç›–æµ‡é¥­", "ä¾¿å½“", "å¯¿å–œçƒ§", "æ¶®ç¾Šè‚‰", "çƒ¤å…¨ç¾Š", "å«èŠ±é¸¡"
                ]
            },
            city: {
                name: "ä¸–ç•ŒåŸå¸‚",
                icon: "ğŸ™ï¸",
                theme: "theme-city",
                items: [
                    "åŒ—äº¬", "ä¸Šæµ·", "å¹¿å·", "æ·±åœ³", "æˆéƒ½", "æ­å·", "è¥¿å®‰", "é‡åº†", "æ­¦æ±‰", "å—äº¬",
                    "å¤©æ´¥", "è‹å·", "é’å²›", "å¦é—¨", "å¤§è¿", "å“ˆå°”æ»¨", "é•¿æ²™", "éƒ‘å·", "æ˜†æ˜", "ä¸‰äºš",
                    "ä¸œäº¬", "å¤§é˜ª", "äº¬éƒ½", "é¦–å°”", "é‡œå±±", "æ›¼è°·", "æ–°åŠ å¡", "å‰éš†å¡", "é›…åŠ è¾¾", "é©¬å°¼æ‹‰",
                    "çº½çº¦", "æ´›æ‰çŸ¶", "æ—§é‡‘å±±", "èŠåŠ å“¥", "åç››é¡¿", "æ³¢å£«é¡¿", "è¿ˆé˜¿å¯†", "è¥¿é›…å›¾", "æ‹‰æ–¯ç»´åŠ æ–¯", "æ–°å¥¥å°”è‰¯",
                    "ä¼¦æ•¦", "å·´é»", "ç½—é©¬", "æŸæ—", "é˜¿å§†æ–¯ç‰¹ä¸¹", "å·´å¡ç½—é‚£", "é©¬å¾·é‡Œ", "ç»´ä¹Ÿçº³", "å¸ƒæ‹‰æ ¼", "å¸ƒè¾¾ä½©æ–¯",
                    "è«æ–¯ç§‘", "åœ£å½¼å¾—å ¡", "ä¼Šæ–¯å¦å¸ƒå°”", "å¼€ç½—", "è¿ªæ‹œ", "å¤šå“ˆ", "ç‰¹æ‹‰ç»´å¤«", "è€¶è·¯æ’’å†·", "é›…å…¸", "åœ£æ‰˜é‡Œå°¼",
                    "æ‚‰å°¼", "å¢¨å°”æœ¬", "å¥¥å…‹å…°", "æƒ çµé¡¿", "ç€æ–¯", "å¸ƒé‡Œæ–¯ç­", "é»„é‡‘æµ·å²¸", "å‡¯æ©æ–¯", "çš‡åé•‡", "æ–æµ",
                    "é‡Œçº¦çƒ­å†…å¢", "åœ£ä¿ç½—", "å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯", "åˆ©é©¬", "æ³¢å“¥å¤§", "åœ£åœ°äºšå“¥", "è’™ç‰¹åˆ©å°”", "æ¸©å“¥å", "å¤šä¼¦å¤š", "å¢¨è¥¿å“¥åŸ"
                ]
            },
            sports: {
                name: "ä½“è‚²è¿åŠ¨",
                icon: "âš½",
                theme: "theme-sports",
                items: [
                    "è¶³çƒ", "ç¯®çƒ", "ç½‘çƒ", "ç¾½æ¯›çƒ", "ä¹’ä¹“çƒ", "æ’çƒ", "æ£’çƒ", "æ©„æ¦„çƒ", "é«˜å°”å¤«", "å°çƒ",
                    "æ¸¸æ³³", "è·³æ°´", "æ°´çƒ", "èŠ±æ ·æ¸¸æ³³", "å†²æµª", "å¸†èˆ¹", "èµ›è‰‡", "çš®åˆ’è‰‡", "é¾™èˆŸ", "æ‘©æ‰˜è‰‡",
                    "ç”°å¾„", "çŸ­è·‘", "é•¿è·‘", "é©¬æ‹‰æ¾", "è·¨æ ", "è·³é«˜", "è·³è¿œ", "é“…çƒ", "é“é¥¼", "æ ‡æª",
                    "ä½“æ“", "è‰ºæœ¯ä½“æ“", "è¹¦åºŠ", "ç‘œä¼½", "æ™®æ‹‰æ", "èˆè¹ˆ", "å•¦å•¦æ“", "å¥ç¾æ“", "æ­¦æœ¯", "è·†æ‹³é“",
                    "æ‹³å‡»", "æ‘”è·¤", "æŸ”é“", "ç©ºæ‰‹é“", "å‰‘é“", "å‡»å‰‘", "æ•£æ‰“", "æ³°æ‹³", "ç›¸æ‰‘", "ç»¼åˆæ ¼æ–—",
                    "æ»‘é›ª", "æ»‘å†°", "å†°çƒ", "å†°å£¶", "é›ªæ©‡", "é›ªè½¦", "å†¬å­£ä¸¤é¡¹", "è·³å°æ»‘é›ª", "å•æ¿æ»‘é›ª", "è¶Šé‡æ»‘é›ª",
                    "è‡ªè¡Œè½¦", "å±±åœ°è½¦", "å…¬è·¯èµ›", "åœºåœ°èµ›", "å°è½®è½¦", "æ‘©æ‰˜è½¦", "èµ›è½¦", "æ‹‰åŠ›èµ›", "å¡ä¸è½¦", "æ–¹ç¨‹å¼",
                    "æ”€å²©", "ç™»å±±", "å¾’æ­¥", "éœ²è¥", "é‡è¥", "é’“é±¼", "ç‹©çŒ", "å°„ç®­", "é£é•–", "ä¿é¾„çƒ"
                ]
            },
            movie: {
                name: "å½±è§†ä½œå“",
                icon: "ğŸ¬",
                theme: "theme-movie",
                items: [
                    "é˜¿å‡¡è¾¾", "æ³°å¦å°¼å…‹å·", "æ˜Ÿçƒå¤§æˆ˜", "æŒ‡ç¯ç‹", "å“ˆåˆ©æ³¢ç‰¹", "å¤ä»‡è€…è”ç›Ÿ", "å˜å½¢é‡‘åˆš", "é€Ÿåº¦ä¸æ¿€æƒ…", "ç¢Ÿä¸­è°", "007ç³»åˆ—",
                    "æ•™çˆ¶", "è‚–ç”³å…‹çš„æ•‘èµ", "è¿™ä¸ªæ€æ‰‹ä¸å¤ªå†·", "ä½ä¿—å°è¯´", "æå‡»ä¿±ä¹éƒ¨", "ç¾ä¸½äººç”Ÿ", "è¾›å¾·å‹’çš„åå•", "é˜¿ç”˜æ­£ä¼ ", "æµ·ä¸Šé’¢ç´å¸ˆ", "å¤©å ‚ç”µå½±é™¢",
                    "åƒä¸åƒå¯»", "é¾™çŒ«", "ä½ çš„åå­—", "å¤©æ°”ä¹‹å­", "å£°ä¹‹å½¢", "ç§’é€Ÿäº”å˜ç±³", "è¨€å¶ä¹‹åº­", "ç©¿è¶Šæ—¶ç©ºçš„å°‘å¥³", "å¤æ—¥å¤§ä½œæˆ˜", "ç‹¼çš„å­©å­é›¨å’Œé›ª",
                    "æµæµªåœ°çƒ", "æˆ˜ç‹¼", "çº¢æµ·è¡ŒåŠ¨", "æˆ‘ä¸æ˜¯è¯ç¥", "å“ªå’ä¹‹é­”ç«¥é™ä¸–", "å§œå­ç‰™", "ç™½è›‡ç¼˜èµ·", "å¤§åœ£å½’æ¥", "å¤§é±¼æµ·æ£ ", "å¯»æ¢¦ç¯æ¸¸è®°",
                    "æƒåŠ›çš„æ¸¸æˆ", "ç»å‘½æ¯’å¸ˆ", "è€å‹è®°", "ç”Ÿæ´»å¤§çˆ†ç‚¸", "è¥¿éƒ¨ä¸–ç•Œ", "é»‘é•œ", "æ€ªå¥‡ç‰©è¯­", "çº¸ç‰Œå±‹", "è¡Œå°¸èµ°è‚‰", "è¶Šç‹±",
                    "å§è™è—é¾™", "è‹±é›„", "åé¢åŸ‹ä¼", "æ»¡åŸå°½å¸¦é»„é‡‘ç”²", "æ— é—´é“", "è®©å­å¼¹é£", "æˆ‘ä¸æ˜¯æ½˜é‡‘è²", "èŠ³å", "å”äººè¡—æ¢æ¡ˆ", "æ‰å¦–è®°",
                    "åŠŸå¤«", "å¤§è¯è¥¿æ¸¸", "å–œå‰§ä¹‹ç‹", "é•¿æ±Ÿä¸ƒå·", "ç¾äººé±¼", "è¥¿æ¸¸é™é­”ç¯‡", "åŠŸå¤«ç‘œä¼½", "å”ä¼¯è™ç‚¹ç§‹é¦™", "ä¹å“èŠéº»å®˜", "é£Ÿç¥",
                    "å¯„ç”Ÿè™«", "ç‡ƒçƒ§", "é‡œå±±è¡Œ", "æš—æ€", "é¸£æ¢æµ·æˆ˜", "è€ç”·å­©", "æ€äººå›å¿†", "é˜³å…‰å§å¦¹æ·˜", "æˆ‘çš„é‡è›®å¥³å‹", "å‡å¦‚çˆ±æœ‰å¤©æ„"
                ]
            },
            tech: {
                name: "ç§‘æŠ€æ•°ç ",
                icon: "ğŸ’»",
                theme: "theme-tech",
                items: [
                    "iPhone", "iPad", "MacBook", "AirPods", "Apple Watch", "iMac", "Mac mini", "HomePod", "Apple TV", "Vision Pro",
                    "åä¸º", "å°ç±³", "OPPO", "vivo", "è£è€€", "ä¸€åŠ ", "realme", "é­…æ—", "åŠªæ¯”äºš", "ä¸­å…´",
                    "ä¸‰æ˜Ÿ", "LG", "ç´¢å°¼", "å¤æ™®", "æ¾ä¸‹", "ä¸œèŠ", "å¯Œå£«é€š", "NEC", "äº¬ç“·", "å¡è¥¿æ¬§",
                    "Windows", "Office", "Surface", "Xbox", "Azure", "Outlook", "Teams", "Skype", "Edge", "Bing",
                    "Android", "Chrome", "YouTube", "Gmail", "Google Maps", "Drive", "Docs", "Photos", "Pixel", "Nest",
                    "Intel", "AMD", "NVIDIA", "Qualcomm", "MediaTek", "Broadcom", "Texas Instruments", "ARM", "Raspberry Pi", "Arduino",
                    "Tesla", "SpaceX", "Amazon", "Facebook", "Twitter", "Instagram", "WhatsApp", "TikTok", "Netflix", "Spotify",
                    "5G", "WiFi", "è“ç‰™", "NFC", "USB", "Thunderbolt", "HDMI", "DisplayPort", "VR", "AR"
                ]
            }
        };

        const PUNISHMENTS = [
            "æ·±æƒ…æ¼”å”±/æœ—è¯µæ‰€é€‰å†…å®¹ (30ç§’)", "æ¨¡ä»¿ç›¸å…³åŠ¨ä½œæ‹ç…§", "çœŸå¿ƒè¯ï¼šè¯´å‡ºä½ æœ€å–œæ¬¢çš„3ä¸ªé€‰é¡¹", "ç”¨æ–¹è¨€æœ—è¯»æ‰€é€‰å†…å®¹",
            "å‘ä¸ªçº¢åŒ…ç»™èµ¢å®¶ (é‡‘é¢éšæ„)", "åš5ä¸ªæ·±è¹²å¹¶ä¸€è¾¹è¯´æ‰€é€‰å†…å®¹", "è®©èµ¢å®¶åœ¨ä½ çš„è„¸ä¸Šç”»ä¸€ä¸ªå°å›¾æ¡ˆ", "å¤§å–Šä¸‰å£°ï¼šæˆ‘æ˜¯æœ€å¼ºç‹è€…ï¼"
        ];

        // --- P2P Global State ---
        let peer = null;
        let conn = null;
        let myRole = null; // 'host' or 'guest'
        let localPoisonSelection = null;
        let selectedCategory = null;
        let roomId = null;
        
        let gameState = {
            status: 'waiting', // waiting, category, setup, battle, gameover
            category: null,
            items: [],
            p1Poison: null,
            p2Poison: null,
            selectedItems: [],
            currentTurn: 'host',
            winner: null,
            punishment: '',
            rematchRequests: { host: false, guest: false },
            bothSelectedSame: false // æ–°å¢ï¼šæ ‡è®°ä¸¤äººæ˜¯å¦é€‰æ‹©äº†ç›¸åŒçš„æ¯’è¯
        };

        // --- UI Functions ---
        function showScreen(name) {
            ['connect', 'category', 'waiting', 'setup', 'battle', 'result'].forEach(id => {
                document.getElementById(`screen-${id}`).classList.add('hidden');
            });
            document.getElementById(`screen-${name}`).classList.remove('hidden');
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function log(msg) {
            console.log(msg);
            const statusEl = document.getElementById('connection-status');
            if (statusEl) statusEl.innerText = msg;
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // --- Room Connection ---
        function createRoom() {
            roomId = Math.floor(Math.random() * 900000 + 100000).toString();
            const peerId = 'witch_game_' + roomId; 
            log("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...");
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                log("åˆ›å»ºæˆåŠŸï¼");
                myRole = 'host';
                document.getElementById('display-room-id').innerText = roomId;
                showScreen('waiting');
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
                gameState.status = 'category';
                syncState();
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    showToast("æˆ¿é—´å·ç”Ÿæˆå†²çªï¼Œè¯·é‡è¯•");
                    createRoom(); // è‡ªåŠ¨é‡è¯•
                } else {
                    showToast("è¿æ¥é”™è¯¯: " + err.type);
                }
            });
        }

        function joinRoom() {
            const input = document.getElementById('room-code-input');
            roomId = input.value.trim();
            if (roomId.length !== 6) {
                showToast("è¯·è¾“å…¥6ä½æˆ¿é—´å·");
                return;
            }

            const peerId = 'witch_game_' + roomId;
            log("æ­£åœ¨æŸ¥æ‰¾æˆ¿é—´...");
            peer = new Peer(); 

            peer.on('open', () => {
                conn = peer.connect(peerId);
                if(!conn) {
                    showToast("æ— æ³•è¿æ¥");
                    return;
                }
                myRole = 'guest';
                setupConnection();
            });

            peer.on('error', (err) => {
                showToast("æ— æ³•è¿æ¥åˆ°æˆ¿é—´ï¼Œå¯èƒ½æˆ¿é—´å·é”™è¯¯æˆ–æˆ¿ä¸»å·²ç¦»çº¿");
            });
        }

        function disconnectRoom() {
            if (conn) {
                conn.close();
                conn = null;
            }
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState = {
                status: 'waiting',
                category: null,
                items: [],
                p1Poison: null,
                p2Poison: null,
                selectedItems: [],
                currentTurn: 'host',
                winner: null,
                punishment: '',
                rematchRequests: { host: false, guest: false },
                bothSelectedSame: false
            };
            
            myRole = null;
            selectedCategory = null;
            localPoisonSelection = null;
            roomId = null;
            
            // é‡ç½®èƒŒæ™¯
            document.body.className = 'min-h-screen flex flex-col items-center justify-center p-4';
            
            showScreen('connect');
        }

        function setupConnection() {
            conn.on('open', () => {
                log("å·²è¿æ¥ï¼");
                if (myRole === 'guest') {
                    gameState.status = 'category';
                    syncState();
                }
            });
            
            conn.on('data', (data) => {
                if (data.type === 'SYNC') {
                    gameState = data.state;
                    renderGame();
                }
                
                if (myRole === 'host' && data.type === 'ACTION') {
                    handleGuestAction(data.payload);
                }
                
                if (data.type === 'EMOTE') {
                    showEmote(data.emoji);
                }
            });
            
            conn.on('close', () => {
                showToast("å¯¹æ–¹å·²æ–­å¼€è¿æ¥");
                disconnectRoom();
            });
        }

        function syncState() {
            renderGame();
            if (conn && conn.open) conn.send({ type: 'SYNC', state: gameState });
        }

        function sendEmote(emoji) {
            showEmote(emoji);
            if (conn && conn.open) conn.send({ type: 'EMOTE', emoji: emoji });
        }

        function showEmote(emoji) {
            const container = document.getElementById('emote-container');
            const el = document.createElement('div');
            el.className = 'emote-float';
            el.innerText = emoji;
            const randomX = Math.random() * 40 - 20; 
            el.style.transform = `translateX(${randomX}px)`;
            
            container.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // --- Category Selection ---
        function selectCategory(category) {
            selectedCategory = category;
            
            // æ›´æ–°UI
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('selected');
            
            // å»¶è¿Ÿæ˜¾ç¤ºä¸‹ä¸€ä¸ªç•Œé¢ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€‰ä¸­æ•ˆæœ
            setTimeout(() => {
                // æ›´æ–°èƒŒæ™¯ä¸»é¢˜
                const categoryInfo = CATEGORY_LIBRARIES[category];
                document.body.className = `min-h-screen flex flex-col items-center justify-center p-4 ${categoryInfo.theme}`;
                
                // å¼€å§‹æ–°æ¸¸æˆ
                startNewGame();
            }, 300);
        }

        // --- Game Logic ---
        function startNewGame() {
            const categoryLib = CATEGORY_LIBRARIES[selectedCategory];
            gameState.category = selectedCategory;
            gameState.items = shuffle([...categoryLib.items]).slice(0, 16);
            gameState.items = shuffle(gameState.items);
            gameState.punishment = PUNISHMENTS[Math.floor(Math.random() * PUNISHMENTS.length)];
            gameState.p1Poison = null;
            gameState.p2Poison = null;
            gameState.selectedItems = [];
            gameState.currentTurn = 'host';
            gameState.winner = null;
            gameState.rematchRequests = { host: false, guest: false };
            gameState.bothSelectedSame = false;
            localPoisonSelection = null;
            
            gameState.status = 'setup';
            syncState();
        }

        function handleGuestAction(payload) {
            if (payload.action === 'SET_POISON') {
                gameState.p2Poison = payload.index;
                checkSetupComplete();
            }
            if (payload.action === 'CLICK_ITEM') {
                processTurn(payload.index);
            }
            if (payload.action === 'REMATCH') {
                gameState.rematchRequests.guest = true;
                checkRematch();
            }
            syncState();
        }

        function submitPoison() {
            if (localPoisonSelection === null) return;
            
            if (myRole === 'host') {
                gameState.p1Poison = localPoisonSelection;
                checkSetupComplete();
                syncState();
            } else {
                conn.send({ type: 'ACTION', payload: { action: 'SET_POISON', index: localPoisonSelection } });
            }
            
            document.getElementById('confirm-poison-btn').innerText = "ç­‰å¾…å¯¹æ–¹...";
            document.getElementById('confirm-poison-btn').disabled = true;
        }

        function checkSetupComplete() {
            if (gameState.p1Poison !== null && gameState.p2Poison !== null) {
                // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ç›¸åŒçš„æ¯’è¯
                if (gameState.p1Poison === gameState.p2Poison) {
                    gameState.bothSelectedSame = true;

                }
                
                gameState.status = 'battle';
                syncState();
            }
        }

        function handleBattleClick(index) {
            if (myRole === 'host') {
                processTurn(index);
                syncState();
            } else {
                conn.send({ type: 'ACTION', payload: { action: 'CLICK_ITEM', index: index } });
            }
        }

        function processTurn(index) {
            if (gameState.selectedItems.includes(index)) return;

            const currentActor = gameState.currentTurn; 
            const myPoison = currentActor === 'host' ? gameState.p1Poison : gameState.p2Poison;
            const opponentPoison = currentActor === 'host' ? gameState.p2Poison : gameState.p1Poison;

            // æ£€æŸ¥æ˜¯å¦è¸©ä¸­äº†å¯¹æ–¹çš„æ¯’è¯
            if (index === opponentPoison) {
                gameState.status = 'gameover';
                gameState.winner = currentActor === 'host' ? 'guest' : 'host';
                gameState.selectedItems.push(index);
            } 
            // æ£€æŸ¥æ˜¯å¦è¸©ä¸­äº†å…±åŒçš„æ¯’è¯ï¼ˆåŒæ–¹é€‰æ‹©ç›¸åŒï¼‰
            else if (gameState.bothSelectedSame && index === myPoison) {
                gameState.status = 'gameover';
                gameState.winner = currentActor === 'host' ? 'guest' : 'host'; // é€‰æ‹©è¯¥é€‰é¡¹çš„ç©å®¶è¾“
                gameState.selectedItems.push(index);
            } 
            // æ­£å¸¸é€‰æ‹©å®‰å…¨é€‰é¡¹
            else {
                gameState.selectedItems.push(index);
                gameState.currentTurn = currentActor === 'host' ? 'guest' : 'host';
            }
        }

        function requestRematch() {
            const btn = document.getElementById('rematch-btn');
            btn.innerText = "ç­‰å¾…å¯¹æ–¹...";
            btn.disabled = true;
            btn.classList.add('opacity-50');

            if (myRole === 'host') {
                gameState.rematchRequests.host = true;
                checkRematch();
                syncState();
            } else {
                conn.send({ type: 'ACTION', payload: { action: 'REMATCH' } });
            }
        }

        function checkRematch() {
            if (gameState.rematchRequests.host && gameState.rematchRequests.guest) {
                // å›åˆ°ä¸»é¢˜é€‰æ‹©ç•Œé¢
                gameState.status = 'category';
                gameState.rematchRequests = { host: false, guest: false };
                syncState();
            }
        }

        // --- Render Logic ---
        function renderGame() {
            if (gameState.status === 'category') {
                showScreen('category');
            } else if (gameState.status === 'setup') {
                showScreen('setup');
                renderSetup();
            } else if (gameState.status === 'battle') {
                showScreen('battle');
                renderBattle();
            } else if (gameState.status === 'gameover') {
                showScreen('result');
                renderResult();
            }
        }

        function renderSetup() {
            const isMeReady = myRole === 'host' ? gameState.p1Poison !== null : gameState.p2Poison !== null;
            const isOpponentReady = myRole === 'host' ? gameState.p2Poison !== null : gameState.p1Poison !== null;

            const statusBadge = document.getElementById('setup-status');
            if (isMeReady && !isOpponentReady) {
                statusBadge.innerText = "ç­‰å¾…å¯¹æ–¹...";
                statusBadge.className = "status-badge bg-blue-100 text-blue-700 animate-pulse";
            } else if (!isMeReady) {
                statusBadge.innerText = "è¯·é€‰æ‹©";
                statusBadge.className = "status-badge bg-yellow-100 text-yellow-700";
            } else if (isMeReady && isOpponentReady) {
                statusBadge.innerText = "å‡†å¤‡å°±ç»ª";
                statusBadge.className = "status-badge bg-green-100 text-green-700";
            }

            const grid = document.getElementById('setup-grid');
            grid.innerHTML = '';
            
            gameState.items.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-gray-800 font-medium h-16 flex items-center justify-between transition-all active:scale-95 relative";
                
                // å¦‚æœæ˜¯è‡ªå·±é€‰æ‹©çš„æ¯’è¯ï¼Œæ·»åŠ æ ‡è®°
                if (index === localPoisonSelection) {
                    btn.className = "bg-red-50 p-4 rounded-xl shadow-inner border-2 border-red-500 text-red-800 font-bold h-16 flex items-center justify-between transform scale-[0.98] relative";
                    const marker = document.createElement('div');
                    marker.className = "poison-marker my-poison";
                    marker.textContent = "æˆ‘";
                    btn.appendChild(marker);
                }
                
                btn.onclick = () => {
                    localPoisonSelection = index;
                    renderSetup(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°UI
                    
                    const cBtn = document.getElementById('confirm-poison-btn');
                    cBtn.disabled = false;
                    cBtn.className = "w-full max-w-md bg-[#0071e3] hover:bg-[#0077ED] text-white font-bold py-4 rounded-2xl transition-all duration-300 shadow-md";
                    cBtn.innerText = "ç¡®è®¤ä¸‹æ¯’";
                };
                
                const textSpan = document.createElement('span');
                textSpan.className = "truncate text-sm";
                textSpan.textContent = item;
                
                const iconSpan = document.createElement('span');
                iconSpan.className = "text-xl opacity-30";
                iconSpan.textContent = "âœ“";
                
                btn.appendChild(textSpan);
                btn.appendChild(iconSpan);
                grid.appendChild(btn);
            });

            if (isMeReady) {
                const cBtn = document.getElementById('confirm-poison-btn');
                cBtn.innerText = "å·²ç¡®è®¤ï¼Œç­‰å¾…å¯¹æ–¹...";
                cBtn.disabled = true;
                cBtn.className = "w-full max-w-md bg-green-500 text-white font-bold py-4 rounded-2xl shadow-md";
            }
        }

        function renderBattle() {
            const isMyTurn = gameState.currentTurn === myRole;
            const statusText = document.getElementById('battle-status-text');
            const turnIndicator = document.getElementById('turn-indicator');
            const safeCount = document.getElementById('safe-count');

            if (isMyTurn) {
                statusText.innerText = "è½®åˆ°ä½ äº†ï¼";
                statusText.className = "text-lg font-bold text-[#0071e3] animate-pulse";
                turnIndicator.className = "bg-[#0071e3] h-1.5 rounded-full transition-all duration-500";
            } else {
                statusText.innerText = "å¯¹æ–¹æ­£åœ¨æ€è€ƒ...";
                statusText.className = "text-lg font-bold text-gray-500";
                turnIndicator.className = "bg-gray-300 h-1.5 rounded-full transition-all duration-500";
            }
            safeCount.innerText = 16 - gameState.selectedItems.length;

            const grid = document.getElementById('battle-grid');
            grid.innerHTML = '';
            
            gameState.items.forEach((item, index) => {
                const isSelected = gameState.selectedItems.includes(index);
                const isMyPoison = (myRole === 'host' && index === gameState.p1Poison) || (myRole === 'guest' && index === gameState.p2Poison);
                const isOppPoison = (myRole === 'host' && index === gameState.p2Poison) || (myRole === 'guest' && index === gameState.p1Poison);
                const isBothPoison = gameState.bothSelectedSame && isMyPoison && isOppPoison;
                
                const btn = document.createElement('button');
                btn.className = "h-20 p-2 rounded-xl text-sm relative transition-all duration-300 flex flex-col items-center justify-center font-bold shadow-sm";
                
                if (isSelected) {
                    if (isBothPoison) {
                        // å…±åŒæ¯’è¯ä¸”è¢«é€‰ä¸­
                        btn.className += " bg-amber-100 border-2 border-amber-400 text-amber-800 opacity-60 cursor-not-allowed";
                        btn.innerHTML = `<span class="line-through">${item}</span>`;
                    } else if (isMyPoison || isOppPoison) {
                        // å¦‚æœæ˜¯æ¯’è¯ä¸”è¢«é€‰ä¸­
                        btn.className += " bg-red-100 border-2 border-red-400 text-red-800 opacity-60 cursor-not-allowed";
                        btn.innerHTML = `<span class="line-through">${item}</span>`;
                    } else {
                        // æ™®é€šè¢«é€‰ä¸­çš„é€‰é¡¹
                        btn.className += " bg-gray-100 border border-gray-200 text-gray-400 opacity-60 cursor-not-allowed";
                        btn.innerHTML = `<span class="line-through">${item}</span>`;
                    }
                    btn.disabled = true;
                } else {
                    if (isMyTurn) {
                        btn.className += " bg-white border border-gray-100 text-gray-800 hover:shadow-md active:scale-95 active:bg-gray-50";
                        btn.onclick = () => handleBattleClick(index);
                    } else {
                        btn.className += " bg-white border border-gray-100 text-gray-800 opacity-80 cursor-wait";
                        btn.disabled = true;
                    }
                    btn.innerHTML = `<span class="z-10">${item}</span><div class="absolute bottom-1 right-2 text-gray-200 text-xs">ğŸ‘†</div>`;
                }
                
                // æ·»åŠ æ¯’è¯æ ‡è®°
                if (isMyPoison && !isSelected) {
                    const marker = document.createElement('div');
                    if (isBothPoison) {
                        marker.className = "poison-marker both-poison";
                        marker.textContent = "å…±";
                    } else {
                        marker.className = "poison-marker my-poison";
                        marker.textContent = "æˆ‘";
                    }
                    btn.appendChild(marker);
                }
                
                grid.appendChild(btn);
            });
        }

        function renderResult() {
            const isWinner = gameState.winner === myRole;
            const myPoisonIndex = myRole === 'host' ? gameState.p1Poison : gameState.p2Poison;
            const oppPoisonIndex = myRole === 'host' ? gameState.p2Poison : gameState.p1Poison;
            
            // Text updates
            const icon = document.getElementById('result-icon');
            const title = document.getElementById('result-title');
            const desc = document.getElementById('result-desc');
            const punish = document.getElementById('result-punishment');
            const bothPoisonInfo = document.getElementById('both-poison-info');

            punish.innerText = gameState.punishment;

            // æ˜¾ç¤ºåŒæ–¹é€‰æ‹©ç›¸åŒæ¯’è¯çš„ä¿¡æ¯
            if (gameState.bothSelectedSame) {
                bothPoisonInfo.classList.remove('hidden');
            } else {
                bothPoisonInfo.classList.add('hidden');
            }

            if (isWinner) {
                icon.innerText = "ğŸ†";
                title.innerText = "èƒœåˆ©!";
                title.className = "text-3xl font-black text-[#0071e3] mb-1";
                if (gameState.bothSelectedSame) {
                    desc.innerText = "å¯¹æ–¹è¸©ä¸­äº†å…±åŒçš„é™·é˜±";
                } else {
                    desc.innerText = "å¯¹æ–¹è¸©ä¸­äº†ä½ çš„é™·é˜±";
                }
            } else {
                icon.innerText = "ğŸ’¥";
                title.innerText = "å¤±è´¥!";
                title.className = "text-3xl font-black text-red-500 mb-1";
                if (gameState.bothSelectedSame) {
                    desc.innerText = "ä½ è¸©ä¸­äº†å…±åŒçš„é™·é˜±";
                } else {
                    desc.innerText = "ä½ è¸©ä¸­äº†å¯¹æ–¹çš„é™·é˜±";
                }
            }

            // Rematch Button Reset
            const rBtn = document.getElementById('rematch-btn');
            const myRequest = myRole === 'host' ? gameState.rematchRequests.host : gameState.rematchRequests.guest;
            if (myRequest) {
                rBtn.innerText = "ç­‰å¾…å¯¹æ–¹...";
                rBtn.classList.add("opacity-50");
                rBtn.disabled = true;
            } else {
                rBtn.innerText = "ğŸ”„ å†æ¥ä¸€å±€";
                rBtn.classList.remove("opacity-50");
                rBtn.disabled = false;
            }

            // Review Grid Render
            const grid = document.getElementById('review-grid');
            grid.innerHTML = '';
            
            gameState.items.forEach((item, index) => {
                const el = document.createElement('div');
                let classes = "h-16 rounded-lg text-xs flex flex-col items-center justify-center font-bold relative p-1 text-center ";
                let content = `<span>${item}</span>`;

                const isSelected = gameState.selectedItems.includes(index);
                const isMyPoison = (index === myPoisonIndex);
                const isOppPoison = (index === oppPoisonIndex);
                const isBothPoison = gameState.bothSelectedSame && isMyPoison && isOppPoison;

                if (isBothPoison) {
                    classes += "bg-amber-50 border-2 border-amber-400 text-amber-800 ";
                    if (isSelected) content += `<div class="absolute inset-0 flex items-center justify-center text-4xl opacity-80">ğŸ’¥</div>`;
                    content += `<div class="poison-marker both-poison">å…±</div>`;
                } else if (isMyPoison) {
                    classes += "bg-red-50 border-2 border-red-400 text-red-800 ";
                    content += `<div class="poison-marker my-poison">æˆ‘</div>`;
                } else if (isOppPoison) {
                    classes += "bg-purple-50 border-2 border-purple-400 text-purple-800 ";
                    if (isSelected) content += `<div class="absolute inset-0 flex items-center justify-center text-4xl opacity-80">ğŸ’¥</div>`;
                    content += `<div class="poison-marker opponent-poison">TA</div>`;
                } else if (isSelected) {
                    classes += "bg-gray-100 text-gray-400 border border-gray-200 ";
                } else {
                    classes += "bg-white text-gray-600 border border-gray-100 ";
                }

                el.className = classes;
                el.innerHTML = content;
                grid.appendChild(el);
            });
        }
    </script>
</body>
</html>
