<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥³å·«çš„æ¯’è¯ - æ­Œæ›²æŒ‘æˆ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* iOS Style System Font */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #f5f5f7; /* Apple Light Grey */
            color: #1d1d1f;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Apple Card Style */
        .ios-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        /* Button Animations */
        .ios-btn {
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .ios-btn:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        /* Slide Transition */
        .slide-up {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mode Selection */
        .mode-card {
            border: 2px solid transparent;
            background: white;
            transition: all 0.2s ease;
        }
        .mode-card.selected {
            border-color: #0071e3; /* iOS Blue */
            background: #f0f8ff;
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.15);
        }
        .mode-card:not(.selected) {
            opacity: 0.6;
            filter: grayscale(100%);
        }

        /* 4x4 Grid for Remote View */
        .big-grid-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
        }
        .number-tag {
            font-size: 2rem; 
            font-weight: 800;
            color: #0071e3;
            line-height: 1;
        }
        .song-name-tag {
            font-size: 0.8rem;
            color: #86868b;
            text-align: center;
            line-height: 1.2;
            margin-top: 4px;
            padding: 0 2px;
            font-weight: 500;
        }

        /* Modal Overlay */
        .modal-bg {
            background-color: rgba(245, 245, 247, 0.98); /* Opaque light bg */
        }
        
        /* Grid Layout Fixes */
        .grid-4x4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Screen 1: Home / Rules -->
    <div id="screen-home" class="w-full max-w-md space-y-6 slide-up text-center">
        <div class="pt-8 pb-4">
            <h1 class="text-4xl font-extrabold tracking-tight text-gray-900 mb-1">å¥³å·«çš„æ¯’è¯</h1>
            <p class="text-gray-500 text-sm font-medium tracking-wide">åŒäººé»˜å¥‘æŒ‘æˆ˜ Â· æ­Œæ›²ç‰ˆ</p>
        </div>

        <!-- Mode Selection -->
        <div class="grid grid-cols-2 gap-4 px-2">
            <div id="mode-local" onclick="selectMode('local')" class="mode-card p-5 rounded-2xl cursor-pointer shadow-sm">
                <div class="text-3xl mb-2">ğŸ¤</div>
                <h3 class="font-bold text-gray-900 text-sm">é¢å¯¹é¢</h3>
                <p class="text-xs text-gray-500 mt-1">ä¼ é€’æ‰‹æœº</p>
            </div>
            <div id="mode-remote" onclick="selectMode('remote')" class="mode-card p-5 rounded-2xl cursor-pointer shadow-sm">
                <div class="text-3xl mb-2">ğŸ“¹</div>
                <h3 class="font-bold text-gray-900 text-sm">è¿œç¨‹è¿çº¿</h3>
                <p class="text-xs text-gray-500 mt-1">è§†é¢‘æŠ¥å·</p>
            </div>
        </div>

        <div class="ios-card p-6 text-left mx-2">
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">æ¸¸æˆè§„åˆ™</h2>
            <ul class="space-y-3 text-sm text-gray-700 font-medium">
                <li class="flex items-start">
                    <span class="mr-3 text-blue-500 font-bold">1</span>
                    <span>æ¯å±€éšæœºæŠ½å– 16 é¦–æ­Œï¼ŒåŒæ–¹å„é€‰ 1 é¦–ä½œä¸º<span class="text-red-500">æ¯’è¯</span>ã€‚</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-3 text-blue-500 font-bold">2</span>
                    <span>è½®æµç‚¹æ­Œï¼Œç‚¹åˆ°å³å”±ã€‚è‹¥ç‚¹ä¸­å¯¹æ–¹æ¯’è¯åˆ™<span class="text-red-500">ç«‹å³æ·˜æ±°</span>ã€‚</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-3 text-blue-500 font-bold">3</span>
                    <span><span class="text-blue-600">è¿çº¿æ¨¡å¼ï¼š</span>ä½ å‘é•œå¤´å±•ç¤ºç›˜é¢ï¼Œå¯¹æ–¹æŠ¥å·åï¼Œä½ ç‚¹å‡»å±å¹•å½•å…¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰“ä¹±é¡ºåºã€‚</span>
                </li>
            </ul>
        </div>

        <button onclick="startGame()" class="w-full bg-[#0071e3] hover:bg-[#0077ED] text-white font-semibold py-4 px-8 rounded-2xl shadow-lg ios-btn text-lg mt-4">
            å¼€å§‹æŒ‘æˆ˜
        </button>
    </div>

    <!-- Screen 2: Setup Phase (Player Selection) -->
    <div id="screen-setup" class="hidden w-full max-w-md flex-col h-screen py-6">
        <div class="flex-none mb-4 px-4">
            <h2 id="setup-title" class="text-2xl font-bold text-gray-900">ç©å®¶ A è®¾æ¯’</h2>
            <p id="setup-subtitle" class="text-gray-500 text-sm mt-1">è¯·é€‰æ‹©ä¸€é¦–æ­Œä½œä¸ºé™·é˜± (å¯¹æ–¹ä¸å¯è§)</p>
        </div>

        <div class="flex-grow overflow-y-auto px-2 pb-24">
            <div id="setup-grid" class="grid grid-cols-2 gap-3">
                <!-- Grid items generated by JS -->
            </div>
        </div>

        <div class="fixed bottom-6 left-0 right-0 px-6 flex justify-center z-20">
             <button id="confirm-poison-btn" disabled onclick="confirmPoison()" class="w-full max-w-md bg-gray-200 text-gray-400 font-bold py-4 rounded-2xl transition-all duration-300 shadow-md">
                è¯·é€‰æ‹©æ¯’è¯
            </button>
        </div>
    </div>

    <!-- Screen 2.5: Remote Setup (Display Grid + Input) -->
    <div id="screen-remote-setup" onclick="openNumberInput()" class="hidden w-full max-w-md flex-col h-screen py-4 bg-[#f5f5f7] cursor-pointer">
        <div class="flex-none text-center mb-4 px-4 pointer-events-none">
            <div class="bg-white px-4 py-2 rounded-full shadow-sm border inline-block">
                <h2 class="text-sm font-bold text-blue-600 flex items-center justify-center gap-2">
                    <span>ğŸ“¹</span> è¯·å±•ç¤ºç»™å¯¹æ–¹çœ‹
                </h2>
            </div>
        </div>

        <!-- 4x4 Grid for Camera -->
        <div class="flex-grow overflow-y-auto px-2 pb-10 pointer-events-none flex items-center">
            <div id="remote-setup-grid" class="grid-4x4 w-full">
                <!-- 4x4 Grid items generated by JS -->
            </div>
        </div>

        <!-- Hint text at bottom -->
        <div class="fixed bottom-8 left-0 right-0 text-center pointer-events-none z-0">
            <p class="text-gray-400 text-sm animate-pulse font-medium">å¯¹æ–¹æŠ¥å·å Â· ç‚¹å‡»å±å¹•ä»»æ„å¤„å½•å…¥</p>
        </div>
    </div>

    <!-- Modal for Number Input -->
    <div id="modal-input" class="hidden fixed inset-0 z-50 modal-bg flex items-center justify-center p-6 slide-up">
        <div class="w-full max-w-sm text-center">
            <h3 class="text-2xl font-bold text-gray-900 mb-2">å¯¹æ–¹é€‰äº†å¤šå°‘å·?</h3>
            <p class="text-sm text-gray-500 mb-8">è¾“å…¥åç³»ç»Ÿå°†é‡æ–°æ´—ç‰Œ</p>
            
            <div class="grid grid-cols-4 gap-3 mb-8">
                <!-- Keypad generated by JS -->
            </div>
            
            <button onclick="event.stopPropagation(); closeNumberInput()" class="text-gray-400 font-medium py-3 px-6 rounded-full hover:bg-gray-100 transition-colors">
                å–æ¶ˆ (è¿”å›å±•ç¤º)
            </button>
        </div>
    </div>

    <!-- Screen 3: Interstitial (Pass Phone) -->
    <div id="screen-pass" class="hidden w-full max-w-md text-center slide-up justify-center flex-col h-screen">
        <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 mx-4">
            <div class="text-6xl mb-6">ğŸ“±</div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">è¯·ä¼ é€’æ‰‹æœº</h2>
            <p class="text-gray-500 mb-8">äº¤ç»™ <span id="next-player-name" class="text-blue-600 font-bold">ç©å®¶ B</span></p>
            <button onclick="nextPhase()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl ios-btn">
                æˆ‘æ˜¯ <span id="next-player-btn-name">ç©å®¶ B</span>
            </button>
        </div>
    </div>

    <!-- Screen 4: Gameplay (Battle) -->
    <div id="screen-battle" class="hidden w-full max-w-md flex-col h-screen py-4">
        <!-- Battle Header -->
        <div class="flex-none mb-4 mx-2 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
            <div>
                <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">å½“å‰å›åˆ</p>
                <h2 id="current-turn-player" class="text-xl font-bold text-gray-900">ç©å®¶ A</h2>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">å®‰å…¨åŒº</p>
                <p id="safe-count" class="text-xl font-mono text-green-500 font-bold">16</p>
            </div>
        </div>

        <!-- Battle Grid -->
        <div class="flex-grow overflow-y-auto px-2 pb-6">
            <div id="battle-grid" class="grid grid-cols-2 gap-3">
                <!-- Battle items generated by JS -->
            </div>
        </div>

        <div class="flex-none text-center text-xs text-gray-400 pb-4 font-medium">
            é€‰ä¸­å¯¹æ–¹æ¯’è¯å³æ·˜æ±°
        </div>
    </div>

    <!-- Screen 5: Game Over -->
    <div id="screen-result" class="hidden w-full max-w-md text-center slide-up z-50 fixed inset-0 bg-white/90 backdrop-blur-xl flex flex-col justify-center items-center p-6">
        <div class="w-full max-w-sm">
            <div id="result-icon" class="text-7xl mb-6 animate-bounce">ğŸ’¥</div>
            <h2 class="text-4xl font-black text-gray-900 mb-2">BOOM!</h2>
            <p class="text-xl text-gray-500 mb-8">
                <span id="loser-name" class="text-red-500 font-bold">ç©å®¶ A</span> è¸©é›·äº†ï¼
            </p>
            
            <div class="bg-gray-50 p-6 rounded-2xl mb-8 border border-gray-100">
                <p class="text-xs text-gray-400 uppercase mb-2 font-bold tracking-widest">è‡´å‘½æ¯’è¯</p>
                <p id="poison-song-name" class="text-2xl font-bold text-gray-900">ğŸµ ä¸ƒé‡Œé¦™</p>
            </div>

            <div class="mb-10">
                <div class="inline-block px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold mb-3">
                    æƒ©ç½šæ—¶é—´
                </div>
                <div id="punishment-text" class="text-gray-800 text-lg font-medium px-4">
                    <!-- Random punishment -->
                </div>
            </div>

            <button onclick="resetGame()" class="w-full bg-[#0071e3] text-white font-bold py-4 rounded-2xl shadow-lg ios-btn text-lg">
                å†æ¥ä¸€å±€
            </button>
        </div>
    </div>

    <script>
        // --- Song Library (Approx 300 popular Chinese songs) ---
        // Generating a large representative list. 
        // Note: For brevity in code, I will include a very large list here.
        const SONG_LIBRARY = [
            "ä¸ƒé‡Œé¦™", "å­¤å‹‡è€…", "æˆéƒ½", "æ¼”å‘˜", "åæ¥", "æ™´å¤©", "åå¹´", "ç¨»é¦™", "ç®€å•çˆ±", "å‘Šç™½æ°”çƒ", "ä½“é¢", "å‡‰å‡‰", "é€†æˆ˜", "æ³¡æ²«", "é‡è§", "å°å¹¸è¿",
            "é’èŠ±ç“·", "æœ¬è‰çº²ç›®", "é¾™å·é£", "ææµ…", "å®‰é™", "å¬å¦ˆå¦ˆçš„è¯", "åƒé‡Œä¹‹å¤–", "èŠèŠ±å°", "å¤œæ›²", "å½©è™¹", "å‘å¦‚é›ª", "ç”œç”œçš„", "è’²å…¬è‹±çš„çº¦å®š", "æœ€é•¿çš„ç”µå½±",
            "æ±Ÿå—", "ä¸€åƒå¹´ä»¥å", "æ›¹æ“", "å°é…’çª", "ä¿®ç‚¼çˆ±æƒ…", "å¯æƒœæ²¡å¦‚æœ", "ä¸ä¸ºè°è€Œä½œçš„æ­Œ", "èƒŒå¯¹èƒŒæ‹¥æŠ±", "å¥¹è¯´", "ç¬¬å‡ ä¸ª100å¤©",
            "ç«¥è¯", "å‹‡æ°”", "æš–æš–", "åˆ†æ‰‹å¿«ä¹", "å´‡æ‹œ", "ç‡•å°¾è¶", "å®å¤", "æƒ…æ­Œ", "å¯æƒœä¸æ˜¯ä½ ", "ä¼šå‘¼å¸çš„ç—›",
            "å”¯ä¸€", "ä¾ç„¶çˆ±ä½ ", "å¤§åŸå°çˆ±", "æ”¹å˜è‡ªå·±", "å¿ƒä¸­çš„æ—¥æœˆ", "èŠ±ç”°é”™", "æˆ‘ä»¬çš„æ­Œ", "éœ€è¦äººé™ª", "ä½ ä¸çŸ¥é“çš„äº‹",
            "å»åˆ«", "ä¸€è·¯ä¸Šæœ‰ä½ ", "é¥è¿œçš„å¥¹", "æ¯å¤©çˆ±ä½ å¤šä¸€äº›", "é¥¿ç‹¼ä¼ è¯´", "å¤´å‘ä¹±äº†", "æ…¢æ…¢", "åªæƒ³ä¸€ç”Ÿè·Ÿä½ èµ°",
            "æµ·é˜”å¤©ç©º", "å…‰è¾‰å²æœˆ", "çœŸçš„çˆ±ä½ ", "ä¸å†çŠ¹è±«", "å–œæ¬¢ä½ ", "æƒ…äºº", "å¤§åœ°", "Amani",
            "çº¢è±†", "åŒ†åŒ†é‚£å¹´", "å› ä¸ºçˆ±æƒ…", "å®¹æ˜“å—ä¼¤çš„å¥³äºº", "æµå¹´", "ä¼ å¥‡", "äººé—´", "ç¬‘å¿˜ä¹¦",
            "å¤§é±¼", "èµ·é£äº†", "æ¶ˆæ„", "åƒæˆ‘è¿™æ ·çš„äºº", "å¹³å‡¡ä¹‹è·¯", "å—å±±å—", "å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ", "è¿½æ¢¦èµ¤å­å¿ƒ", "è“è²èŠ±", "æ›¾ç»çš„ä½ ",
            "ä¸å¾—ä¸çˆ±", "å¿«ä¹å´‡æ‹œ", "å£è™æ¼«æ­¥", "æˆ‘çš„éº¦å…‹é£", "åè½¬åœ°çƒ", "æ½˜æœµæ‹‰", "å¯“è¨€", "é—å¤±çš„ç¾å¥½", "éšå½¢çš„ç¿…è†€", "æ¬§è‹¥æ‹‰",
            "Super Star", "æ³¢æ–¯çŒ«", "ä¸æƒ³é•¿å¤§", "ä¸­å›½è¯", "Shero", "ç—›å¿«", "æ‹äººæœªæ»¡", "çƒ­å¸¦é›¨æ—",
            "æ—¥ä¸è½", "å€’å¸¦", "å¸ƒæ‹‰æ ¼å¹¿åœº", "èˆå¨˜", "ç‰¹åŠ¡J", "çˆ±æƒ…ä¸‰åå…­è®¡", "ä»Šå¤©ä½ è¦å«ç»™æˆ‘", "è¯´çˆ±ä½ ",
            "å½“ä½ ", "çˆ±ä½ ", "ç«æ¯›å¼¯å¼¯", "ç¬¬ä¸€æ¬¡çˆ±çš„äºº", "é‚£å¹´å¤å¤©", "æ¬§è‹¥æ‹‰", "æ·‹é›¨ä¸€ç›´èµ°",
            "å¹´å°‘æœ‰ä¸º", "æç™½", "æ¨¡ç‰¹", "å–œå‰§ä¹‹ç‹", "ä¸å°†å°±", "æˆ’çƒŸ", "éº»é›€", "è€è¡—",
            "ç”»", "èµµé›·", "ç†æƒ³", "å—æ–¹å§‘å¨˜", "å°‘å¹´", "å…‰ç‚¹", "æ— ç¾", "å¤§ç¢—å®½é¢",
            "èŠ’ç§", "ç»¿è‰²", "ä½ çš„é…’é¦†å¯¹æˆ‘æ‰“äº†çƒŠ", "æ¥è‡ªå¤©å ‚çš„é­”é¬¼", "å¤šè¿œéƒ½è¦åœ¨ä¸€èµ·", "å†è§", "å…‰å¹´ä¹‹å¤–",
            "å¤©é»‘é»‘", "å¼€å§‹æ‡‚äº†", "é‡è§", "ç»¿å…‰", "é€†å…‰", "æˆ‘æ€€å¿µçš„", "é›¨å¤©",
            "ç››å¤çš„æœå®", "é˜´å¤©", "å¹¿å²›ä¹‹æ‹", "ç”µå°æƒ…æ­Œ", "å¦‚æœæ²¡æœ‰ä½ ", "å¿½ç„¶ä¹‹é—´",
            "Kæ­Œä¹‹ç‹", "å¯Œå£«å±±ä¸‹", "æµ®å¤¸", "å•è½¦", "ä¸€ä¸ä¸æŒ‚", "å¥½ä¹…ä¸è§", "æ·˜æ±°", "çº¢ç«ç‘°",
            "æ´‹è‘±", "çŸ¥è¶³", "æ¸©æŸ”", "å€”å¼º", "çªç„¶å¥½æƒ³ä½ ", "ç¦»å¼€åœ°çƒè¡¨é¢", "æ‹çˆ±ing", "ç§å¥”åˆ°æœˆçƒ", "æ˜Ÿç©º",
            "è¿™å°±æ˜¯çˆ±", "é€†æˆ˜", "å¤©ä¸‹", "æ˜å¤©è¿‡å", "çœ‹æœˆäº®çˆ¬ä¸Šæ¥", "å‹¿å¿˜å¿ƒå®‰",
            "å¦‚æœè¿™éƒ½ä¸ç®—çˆ±", "ç‹å¦ƒ", "æ–°ä¸äº†æƒ…", "æ²¡é‚£ä¹ˆç®€å•", "ç‹å¦ƒ", "èƒŒå›", "æ— æ‰€è°“",
            "è®¤é”™", "å¤–æ»©åå…«å·", "è¯¥æ­»çš„æ¸©æŸ”", "æ±‚ä½›", "è€é¼ çˆ±å¤§ç±³", "ä¸¤åªè´è¶", "æœˆäº®ä¹‹ä¸Š", "æœ€ç‚«æ°‘æ—é£", "è·å¡˜æœˆè‰²",
            "é‚£äº›å¹´", "å°æƒ…æ­Œ", "æ— ä¸ä¼¦æ¯”çš„ç¾ä¸½", "æˆ‘å¥½æƒ³ä½ ", "èµ·é£äº†", "å°‘å¹´", "çƒ­çˆ±105Â°Cçš„ä½ ",
            "ç§’é’ˆ", "æ¼ æ²³èˆå…", "å­¤å‹‡è€…", "è±è‰èŠ±", "è¿™ä¸–ç•Œé‚£ä¹ˆå¤šäºº", "å¦‚æ„¿", "äººä¸–é—´", "æ—©å®‰éš†å›", "ä¹Œæ¢…å­é…±",
            "å‹‡æ°”", "ç¬¬ä¸€æ¬¡", "ç«¥è¯", "çº¦å®š", "åæ¥", "æˆå…¨", "çˆ±çš„ä»£ä»·", "å½“çˆ±å·²æˆå¾€äº‹",
            "çœŸå¿ƒè‹±é›„", "æœ‹å‹", "èŠ±å¿ƒ", "åˆ€å‰‘å¦‚æ¢¦", "æ²§æµ·ä¸€å£°ç¬‘", "éš¾å¿µçš„ç»", "é“è¡€ä¸¹å¿ƒ", "ä¸–é—´å§‹ç»ˆä½ å¥½",
            "åƒåƒé˜™æ­Œ", "é£˜é›ª", "çº¢æ—¥", "æœˆåŠå°å¤œæ›²", "æŠ¤èŠ±ä½¿è€…", "å¤„å¤„å»", "é‡å­©å­", "å°‘å¥³çš„ç¥ˆç¥·",
            "ä¸‹ä¸€ç«™å¤©å", "æ­»æ€§ä¸æ”¹", "æ‹çˆ±å¤§è¿‡å¤©", "çœ¼çº¢çº¢", "å¥½å¿ƒåˆ†æ‰‹", "å¤§å“¥",
            "è‡³å°‘è¿˜æœ‰ä½ ", "çˆ±å¦‚æ½®æ°´", "è¿‡ç«", "ä¿¡ä»°", "çˆ±å°±ä¸€ä¸ªå­—", "ç™½æœˆå…‰",
            "æ°´æ‰‹", "æ˜Ÿæ˜Ÿç‚¹ç¯", "å¤§çº¦åœ¨å†¬å­£", "å¤–é¢çš„ä¸–ç•Œ", "å†å›é¦–", "è·Ÿå¾€äº‹å¹²æ¯",
            "å¿ƒå¤ªè½¯", "ä¼¤å¿ƒå¤ªå¹³æ´‹", "ä»»é€é¥", "å¯¹é¢çš„å¥³å­©çœ‹è¿‡æ¥", "æµªèŠ±ä¸€æœµæœµ", "æ˜¥å¤©èŠ±ä¼šå¼€",
            "æ— åœ°è‡ªå®¹", "ä¸€æ— æ‰€æœ‰", "èŠ±æˆ¿å§‘å¨˜", "æ–°é•¿å¾è·¯ä¸Šçš„æ‘‡æ»š", "å‡è¡Œåƒ§",
            "æŒªå¨çš„æ£®æ—", "çªç„¶çš„è‡ªæˆ‘", "æµªäººæƒ…æ­Œ", "Last Dance", "ç—›å“­çš„äºº",
            "å•èº«æƒ…æ­Œ", "è’™å¨œä¸½èçš„çœ¼æ³ª", "ç¦»æ­Œ", "æ­»äº†éƒ½è¦çˆ±", "å¤©é«˜åœ°åš",
            "ç—´å¿ƒç»å¯¹", "æ‰‹æ”¾å¼€", "ä¸€ä¸‡ä¸ªç†ç”±", "æœ‰æ²¡æœ‰äººå‘Šè¯‰ä½ ", "æœ‰æ²¡æœ‰é‚£ä¹ˆä¸€é¦–æ­Œ",
            "è´åŠ å°”æ¹–ç•”", "çˆ¶äº²", "å½“ä½ è€äº†", "æ—¶é—´éƒ½å»å“ªå„¿äº†", "å¸¸å›å®¶çœ‹çœ‹",
            "å¥½è¿æ¥", "æ­å–œå‘è´¢", "éš¾å¿˜ä»Šå®µ", "æˆ‘å’Œæˆ‘çš„ç¥–å›½", "æ­Œå”±ç¥–å›½"
        ];

        const PUNISHMENTS = [
            "æ·±æƒ…æ¼”å”±è¿™é¦–æ­Œçš„å‰¯æ­Œ (30ç§’)",
            "æ¨¡ä»¿åŸå”±çš„ç»å…¸åŠ¨ä½œæ‹ç…§",
            "çœŸå¿ƒè¯ï¼šè¯´å‡ºä½ ç°åœ¨çš„å±ä¿æ˜¯è°",
            "ç”¨æ–¹è¨€æœ—è¯»è¿™é¦–æ­Œçš„æ­Œè¯",
            "å‘ä¸ªçº¢åŒ…ç»™èµ¢å®¶ (é‡‘é¢éšæ„)",
            "åš5ä¸ªæ·±è¹²å¹¶ä¸€è¾¹å”±è¿™é¦–æ­Œ",
            "è®©èµ¢å®¶åœ¨ä½ çš„è„¸ä¸Šç”»ä¸€ä¸ªå°å›¾æ¡ˆ",
            "å¤§å–Šä¸‰å£°ï¼šæˆ‘æ˜¯éº¦éœ¸ï¼",
            "å±•ç¤ºä½ ç›¸å†Œé‡Œæœ€æ–°çš„é‚£å¼ ç…§ç‰‡",
            "ä¿æŒè¿™ä¸ªå§¿åŠ¿ç›´åˆ°ä¸‹ä¸€è½®å¼€å§‹"
        ];

        // --- State Management ---
        let gameState = {
            mode: 'local', 
            step: 0, 
            currentGameSongs: [], // The 16 songs for this session
            currentList: [], // The shuffled list for display
            p1PoisonName: null, 
            p2PoisonName: null,
            currentTurn: 1, 
            sungSongs: [], 
            tempSelectionName: null 
        };

        // --- DOM Elements ---
        const screens = {
            home: document.getElementById('screen-home'),
            setup: document.getElementById('screen-setup'),
            remoteSetup: document.getElementById('screen-remote-setup'),
            pass: document.getElementById('screen-pass'),
            battle: document.getElementById('screen-battle'),
            result: document.getElementById('screen-result')
        };

        // --- Utils ---
        function shuffle(array) {
            let currentIndex = array.length,  randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // Pick n random unique elements from array
        function getRandomSongs(allSongs, count) {
            const shuffled = shuffle([...allSongs]); // Copy before shuffle
            return shuffled.slice(0, count);
        }

        // --- Functions ---

        function selectMode(mode) {
            gameState.mode = mode;
            document.getElementById('mode-local').classList.remove('selected');
            document.getElementById('mode-remote').classList.remove('selected');
            
            document.getElementById(`mode-${mode}`).classList.add('selected');
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        function startGame() {
            gameState.step = 1;
            gameState.p1PoisonName = null;
            gameState.p2PoisonName = null;
            gameState.sungSongs = [];
            gameState.currentTurn = 1;
            
            // 1. Pick 16 Random Songs from the Big Library
            gameState.currentGameSongs = getRandomSongs(SONG_LIBRARY, 16);
            
            // 2. Initial Shuffle for P1 Setup
            gameState.currentList = shuffle([...gameState.currentGameSongs]);
            
            setupPhase(1);
        }

        function resetGame() {
            showScreen('home');
        }

        // Setup Phase Logic (P1 or Local P2)
        function setupPhase(playerNum) {
            gameState.tempSelectionName = null;
            
            let title = `ç©å®¶ ${playerNum === 1 ? 'A' : 'B'} è®¾æ¯’`;
            let sub = "è¯·é€‰æ‹©ä¸€é¦–æ­Œä½œä¸ºé™·é˜±";
            if (gameState.mode === 'remote' && playerNum === 1) {
                title = "æ­¥éª¤ 1: æˆ‘ (ç©å®¶A) è®¾æ¯’";
                sub = "å…ˆä¸ºè‡ªå·±é€‰å®šä¸€ä¸ªæ¯’è¯ï¼Œå¯¹æ–¹ä¸å¯è§";
            }
            
            document.getElementById('setup-title').innerText = title;
            document.getElementById('setup-subtitle').innerText = sub;

            const confirmBtn = document.getElementById('confirm-poison-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerText = "è¯·é€‰æ‹©æ¯’è¯";
            confirmBtn.className = "w-full max-w-md bg-gray-200 text-gray-400 font-bold py-4 rounded-2xl transition-all duration-300 shadow-none";

            const grid = document.getElementById('setup-grid');
            grid.innerHTML = '';

            gameState.currentList.forEach((song, index) => {
                const btn = document.createElement('button');
                btn.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-gray-800 font-medium h-16 flex items-center justify-between transition-all active:scale-95";
                btn.onclick = () => selectTempPoison(song, btn);
                btn.innerHTML = `
                    <span class="truncate text-sm">${song}</span>
                    <span class="text-xl opacity-30">ğŸµ</span>
                `;
                grid.appendChild(btn);
            });

            showScreen('setup');
        }

        function selectTempPoison(songName, btnElement) {
            // Reset Styles
            const allBtns = document.getElementById('setup-grid').children;
            for (let b of allBtns) {
                b.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-gray-800 font-medium h-16 flex items-center justify-between transition-all active:scale-95";
                b.querySelector('span:last-child').innerHTML = 'ğŸµ';
                b.querySelector('span:last-child').className = "text-xl opacity-30";
            }

            // Active Style (Apple Style Selection)
            btnElement.className = "bg-blue-50 p-4 rounded-xl shadow-inner border-2 border-blue-500 text-blue-800 font-bold h-16 flex items-center justify-between transform scale-[0.98]";
            btnElement.querySelector('span:last-child').innerHTML = 'â˜ ï¸';
            btnElement.querySelector('span:last-child').className = "text-xl";

            gameState.tempSelectionName = songName;
            
            const confirmBtn = document.getElementById('confirm-poison-btn');
            confirmBtn.disabled = false;
            confirmBtn.innerText = "ç¡®è®¤ä¸‹æ¯’";
            confirmBtn.className = "w-full max-w-md bg-[#0071e3] hover:bg-[#0077ED] text-white font-bold py-4 rounded-2xl transition-all duration-300 shadow-lg";
        }

        function confirmPoison() {
            if (gameState.step === 1) {
                // P1 finished
                gameState.p1PoisonName = gameState.tempSelectionName;
                
                if (gameState.mode === 'remote') {
                    startRemoteSetup();
                } else {
                    gameState.step = 2;
                    gameState.currentList = shuffle([...gameState.currentGameSongs]); 
                    showPassScreen(2);
                }

            } else if (gameState.step === 3) {
                // P2 finished (Local)
                gameState.p2PoisonName = gameState.tempSelectionName;
                gameState.step = 4;
                gameState.currentList = shuffle([...gameState.currentGameSongs]);
                showPassScreen(1, true); 
            }
        }

        // --- Remote Setup Logic ---
        function startRemoteSetup() {
            // 1. Shuffle again before showing remote grid
            gameState.currentList = shuffle([...gameState.currentGameSongs]);
            
            const grid = document.getElementById('remote-setup-grid');
            grid.innerHTML = '';

            gameState.currentList.forEach((song, index) => {
                const cell = document.createElement('div');
                cell.className = "big-grid-cell";
                
                // 4x4 Grid - Huge Numbers, Clear Text
                cell.innerHTML = `
                    <div class="number-tag">${index + 1}</div>
                    <div class="song-name-tag remote-song-name">${song}</div>
                `;
                grid.appendChild(cell);
            });

            // Prepare Modal Keypad (1-16)
            const modalGrid = document.querySelector('#modal-input .grid');
            modalGrid.innerHTML = '';
            for(let i=1; i<=16; i++) {
                const b = document.createElement('button');
                b.innerText = i;
                b.className = "aspect-square bg-gray-100 hover:bg-blue-100 text-blue-600 font-bold text-xl rounded-2xl transition-colors shadow-sm";
                b.onclick = (e) => {
                    e.stopPropagation();
                    handleRemoteInput(i);
                };
                modalGrid.appendChild(b);
            }

            showScreen('remoteSetup');
        }

        function openNumberInput() {
            // Hide song names immediately
            const songNames = document.querySelectorAll('.remote-song-name');
            songNames.forEach(el => el.style.opacity = '0');

            document.getElementById('modal-input').classList.remove('hidden');
        }

        function closeNumberInput() {
            // Show song names if cancelled
            const songNames = document.querySelectorAll('.remote-song-name');
            songNames.forEach(el => el.style.opacity = '1');

            document.getElementById('modal-input').classList.add('hidden');
        }

        function handleRemoteInput(number) {
            document.getElementById('modal-input').classList.add('hidden');
            
            const index = number - 1;
            const selectedSong = gameState.currentList[index];
            gameState.p2PoisonName = selectedSong;
            
            // Shuffle again for Battle
            gameState.currentList = shuffle([...gameState.currentGameSongs]);
            
            // Apple style alert/confirm isn't possible natively without library, using alert for simplicity
            // or we could build a custom modal. For now, alert is safe.
            alert(`âœ… è®¾ç½®æˆåŠŸï¼\nTA é€‰æ‹©äº† ${number} å·\n\nç³»ç»Ÿå°†å†æ¬¡æ‰“ä¹±é¡ºåºå¼€å§‹å¯¹æˆ˜...`);
            
            startBattle();
        }

        function showPassScreen(nextPlayerNum, isReadyToBattle = false) {
            const playerLabel = nextPlayerNum === 1 ? 'A' : 'B';
            document.getElementById('next-player-name').innerText = `ç©å®¶ ${playerLabel}`;
            document.getElementById('next-player-btn-name').innerText = `ç©å®¶ ${playerLabel}`;
            
            const btn = document.querySelector('#screen-pass button');
            if(isReadyToBattle) {
                btn.onclick = startBattle;
                btn.innerText = `æˆ‘æ˜¯ ç©å®¶ Aï¼Œå¼€å§‹å¯¹å†³`;
                btn.className = "w-full bg-[#0071e3] text-white font-bold py-4 rounded-xl ios-btn";
            } else {
                btn.onclick = () => {
                    gameState.step = 3;
                    setupPhase(2);
                };
                btn.className = "w-full bg-gray-900 text-white font-bold py-4 rounded-xl ios-btn";
            }
            showScreen('pass');
        }

        // Battle Phase Logic
        function startBattle() {
            gameState.step = 5;
            gameState.currentTurn = 1;
            gameState.sungSongs = [];
            renderBattleGrid();
            updateTurnHeader();
            showScreen('battle');
        }

        function updateTurnHeader() {
            const p = gameState.currentTurn === 1 ? 'A' : 'B';
            const colorClass = gameState.currentTurn === 1 ? 'text-blue-600' : 'text-green-600';
            
            let playerText = `ç©å®¶ ${p}`;
            if (gameState.mode === 'remote') {
                 playerText = gameState.currentTurn === 1 ? 'ç©å®¶ A (æˆ‘)' : 'ç©å®¶ B (è¿çº¿)';
            }

            const el = document.getElementById('current-turn-player');
            el.innerText = playerText;
            el.className = `text-xl font-bold transition-all duration-300 ${colorClass}`;
            
            document.getElementById('safe-count').innerText = 16 - gameState.sungSongs.length;
        }

        function renderBattleGrid() {
            const grid = document.getElementById('battle-grid');
            grid.innerHTML = '';

            gameState.currentList.forEach((song, index) => {
                const isSung = gameState.sungSongs.includes(song);
                const btn = document.createElement('button');
                
                // Apple Style Battle Cards
                let classes = "h-20 p-2 rounded-xl text-sm relative transition-all duration-300 flex flex-col items-center justify-center font-bold shadow-sm ";
                
                if (isSung) {
                    // Reveal state
                    classes += "bg-gray-100 border border-gray-200 text-gray-400 opacity-60 cursor-not-allowed";
                    btn.disabled = true;
                    btn.innerHTML = `<span class="line-through">${song}</span>`;
                } else {
                    // Active state
                    classes += "bg-white border border-gray-100 text-gray-800 hover:shadow-md active:scale-95 active:bg-gray-50";
                    btn.onclick = () => handleSongClick(song, index);
                    btn.innerHTML = `
                        <span class="z-10">${song}</span>
                        <div class="absolute bottom-1 right-2 text-gray-200 text-xs">ğŸ¤</div>
                    `;
                }

                btn.className = classes;
                grid.appendChild(btn);
            });
        }

        function handleSongClick(songName, index) {
            const currentPlayer = gameState.currentTurn;
            const opponentPoison = currentPlayer === 1 ? gameState.p2PoisonName : gameState.p1PoisonName;

            if (songName === opponentPoison) {
                // LOST!
                triggerGameOver(currentPlayer, songName);
            } else {
                // Safe
                gameState.sungSongs.push(songName);
                
                const btns = document.getElementById('battle-grid').children;
                btns[index].className = "h-20 p-2 rounded-xl border border-green-200 bg-green-50 text-green-600 font-bold flex items-center justify-center animate-pulse";
                btns[index].innerHTML = "<span>å®‰å…¨ âœ…</span>";

                setTimeout(() => {
                    if (gameState.sungSongs.length === 16) {
                        alert("å¹³å±€ï¼å®Œç¾é—ªé¿ï¼");
                        resetGame();
                        return;
                    }
                    gameState.currentTurn = currentPlayer === 1 ? 2 : 1;
                    renderBattleGrid();
                    updateTurnHeader();
                }, 500);
            }
        }

        function triggerGameOver(loserNum, poisonName) {
            let loserName = loserNum === 1 ? 'ç©å®¶ A' : 'ç©å®¶ B';
            if (gameState.mode === 'remote') {
                 loserName = loserNum === 1 ? 'ç©å®¶ A (æˆ‘)' : 'ç©å®¶ B (è¿çº¿)';
            }
            
            const punishment = PUNISHMENTS[Math.floor(Math.random() * PUNISHMENTS.length)];

            document.getElementById('loser-name').innerText = loserName;
            document.getElementById('poison-song-name').innerText = `ğŸµ ${poisonName}`;
            document.getElementById('punishment-text').innerText = punishment;

            showScreen('result');
        }

        // Initialize mode on load
        selectMode('local');
    </script>
</body>
</html>