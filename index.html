<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥³å·«çš„æ¯’è¯ (P2På¢å¼ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS (å›½å†… BootCDN åŠ é€Ÿ) -->
    <script src="https://cdn.bootcdn.net/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .ios-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: saturate(180%) blur(20px);
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .ios-btn {
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .ios-btn:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinner {
            border: 3px solid rgba(0, 113, 227, 0.1);
            border-left-color: #0071e3;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Emote Animations */
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            80% { transform: translateY(-80px) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.8); opacity: 0; }
        }
        .emote-float {
            position: fixed;
            bottom: 100px;
            left: 50%;
            font-size: 4rem;
            pointer-events: none;
            z-index: 100;
            margin-left: -2rem; /* center */
            animation: floatUp 2s ease-out forwards;
        }
        
        /* Grid Animations */
        .grid-cell-reveal {
            transition: all 0.5s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Emote Overlay Container -->
    <div id="emote-container"></div>

    <!-- Screen 1: Lobby -->
    <div id="screen-lobby" class="w-full max-w-md space-y-6 slide-up text-center">
        <div class="pt-8 pb-4">
            <h1 class="text-4xl font-extrabold tracking-tight text-gray-900 mb-1">å¥³å·«çš„æ¯’è¯</h1>
            <p class="text-gray-500 text-sm font-medium tracking-wide">P2Pè”æœºå¢å¼ºç‰ˆ</p>
        </div>

        <div class="space-y-4 px-2">
            <button onclick="createRoom()" class="w-full bg-[#0071e3] hover:bg-[#0077ED] text-white font-semibold py-5 px-8 rounded-2xl shadow-lg ios-btn flex items-center justify-center gap-3">
                <span>ğŸ </span> åˆ›å»ºæˆ¿é—´ (æˆ‘æ˜¯æˆ¿ä¸»)
            </button>
            
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-[#f5f5f7] text-gray-500">æˆ–è€…</span>
                </div>
            </div>

            <div class="flex gap-2">
                <input id="room-code-input" type="number" placeholder="è¾“å…¥æˆ¿ä¸»ç»™çš„æˆ¿é—´å·" class="flex-1 p-4 rounded-2xl border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 font-mono text-center text-lg">
                <button onclick="joinRoom()" class="bg-gray-900 text-white font-semibold px-6 rounded-2xl ios-btn">
                    åŠ å…¥
                </button>
            </div>
        </div>

        <div id="connection-status" class="text-xs text-gray-400 mt-4 h-4"></div>
    </div>

    <!-- Screen 2: Waiting Room -->
    <div id="screen-waiting" class="hidden w-full max-w-md flex-col items-center justify-center h-screen slide-up">
        <div class="ios-card p-8 w-full text-center space-y-6">
            <div class="spinner mx-auto mb-2"></div>
            <h2 class="text-2xl font-bold text-gray-900">ç­‰å¾…å¥½å‹åŠ å…¥...</h2>
            
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                <p class="text-xs text-blue-500 uppercase font-bold mb-1">æˆ¿é—´å·</p>
                <p id="display-room-id" class="text-4xl font-mono font-black text-blue-600 tracking-widest">---</p>
            </div>
            
            <p class="text-sm text-gray-500">å‘Šè¯‰å¯¹æ–¹è¾“å…¥æ­¤å·ç <br><span class="text-xs text-red-400">*æˆ¿ä¸»è¯·å‹¿å…³é—­æ­¤é¡µé¢</span></p>
        </div>
    </div>

    <!-- Screen 3: Setup Phase -->
    <div id="screen-setup" class="hidden w-full max-w-md flex-col h-screen py-6">
        <div class="flex-none mb-4 px-4">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-2xl font-bold text-gray-900">é€‰æ‹©æ¯’è¯</h2>
                <span id="setup-status" class="status-badge bg-yellow-100 text-yellow-700">ç­‰å¾…åŒæ–¹å‡†å¤‡</span>
            </div>
            <p class="text-gray-500 text-sm">ç‚¹å‡»ä¸€é¦–æ­Œè®¾ä¸ºé™·é˜±ï¼Œå¯¹æ–¹ä¸å¯è§</p>
        </div>

        <div class="flex-grow overflow-y-auto px-2 pb-24">
            <div id="setup-grid" class="grid grid-cols-2 gap-3">
                <!-- Grid items generated by JS -->
            </div>
        </div>

        <div class="fixed bottom-6 left-0 right-0 px-6 flex justify-center z-20">
             <button id="confirm-poison-btn" disabled onclick="submitPoison()" class="w-full max-w-md bg-gray-200 text-gray-400 font-bold py-4 rounded-2xl transition-all duration-300 shadow-md">
                è¯·é€‰æ‹©ä¸€é¦–æ­Œ
            </button>
        </div>
    </div>

    <!-- Screen 4: Battle Phase -->
    <div id="screen-battle" class="hidden w-full max-w-md flex-col h-screen py-4 relative">
        <!-- Battle Header -->
        <div class="flex-none mb-4 mx-2 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">å½“å‰çŠ¶æ€</p>
                    <h2 id="battle-status-text" class="text-lg font-bold text-gray-900">å¯¹æ–¹æ­£åœ¨æ€è€ƒ...</h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">å®‰å…¨åŒº</p>
                    <p id="safe-count" class="text-xl font-mono text-green-500 font-bold">16</p>
                </div>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-1.5">
                <div id="turn-indicator" class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: 50%"></div>
            </div>
        </div>

        <!-- Battle Grid -->
        <div class="flex-grow overflow-y-auto px-2 pb-20">
            <div id="battle-grid" class="grid grid-cols-2 gap-3">
                <!-- Battle items generated by JS -->
            </div>
        </div>

        <!-- Emote Bar -->
        <div class="fixed bottom-6 left-0 right-0 px-4 flex justify-center z-20">
            <div class="bg-white/90 backdrop-blur shadow-xl border border-gray-200 rounded-full px-4 py-2 flex gap-4">
                <button onclick="sendEmote('ğŸ˜±')" class="text-2xl hover:scale-125 transition-transform">ğŸ˜±</button>
                <button onclick="sendEmote('ğŸ¤”')" class="text-2xl hover:scale-125 transition-transform">ğŸ¤”</button>
                <button onclick="sendEmote('ğŸ¤£')" class="text-2xl hover:scale-125 transition-transform">ğŸ¤£</button>
                <button onclick="sendEmote('ğŸ«£')" class="text-2xl hover:scale-125 transition-transform">ğŸ«£</button>
                <button onclick="sendEmote('ğŸ˜¡')" class="text-2xl hover:scale-125 transition-transform">ğŸ˜¡</button>
            </div>
        </div>
    </div>

    <!-- Screen 5: Game Over / Review -->
    <div id="screen-result" class="hidden w-full max-w-md text-center slide-up z-50 fixed inset-0 bg-[#f5f5f7] flex flex-col h-screen overflow-hidden">
        
        <!-- Result Header (Fixed) -->
        <div class="flex-none p-6 pb-2 bg-white shadow-sm z-10">
            <div id="result-icon" class="text-6xl mb-2">ğŸ†</div>
            <h2 id="result-title" class="text-3xl font-black text-gray-900 mb-1">èƒœåˆ©!</h2>
            <p id="result-desc" class="text-lg text-gray-500">å¯¹æ–¹å–ä¸‹äº†æ¯’è¯</p>
            
            <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-xl p-3">
                <span class="text-xs font-bold text-yellow-700 uppercase">æƒ©ç½š</span>
                <p id="result-punishment" class="text-gray-900 font-medium">---</p>
            </div>
        </div>

        <!-- Review Grid (Scrollable) -->
        <div class="flex-grow overflow-y-auto p-4 bg-[#f5f5f7]">
            <div class="flex items-center justify-between mb-2 px-2">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">æˆ˜å±€å¤ç›˜</h3>
                <div class="flex gap-3 text-xs">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500"></span>æˆ‘ä¸‹çš„æ¯’</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-purple-500"></span>TAä¸‹çš„æ¯’</div>
                </div>
            </div>
            <div id="review-grid" class="grid grid-cols-4 gap-2 opacity-90">
                <!-- Review items generated by JS -->
            </div>
        </div>

        <!-- Footer Actions (Fixed) -->
        <div class="flex-none p-4 bg-white border-t border-gray-200">
            <button onclick="requestRematch()" id="rematch-btn" class="w-full bg-[#0071e3] hover:bg-[#0077ED] text-white font-bold py-4 rounded-2xl shadow-lg ios-btn text-lg flex items-center justify-center gap-2">
                <span>ğŸ”„</span> å†æ¥ä¸€å±€
            </button>
        </div>
    </div>

    <script>
        const SONG_LIBRARY = [
            "ä¸ƒé‡Œé¦™", "å­¤å‹‡è€…", "æˆéƒ½", "æ¼”å‘˜", "åæ¥", "æ™´å¤©", "åå¹´", "ç¨»é¦™", "ç®€å•çˆ±", "å‘Šç™½æ°”çƒ", "ä½“é¢", "å‡‰å‡‰", "é€†æˆ˜", "æ³¡æ²«", "é‡è§", "å°å¹¸è¿",
            "é’èŠ±ç“·", "æœ¬è‰çº²ç›®", "é¾™å·é£", "ææµ…", "å®‰é™", "å¬å¦ˆå¦ˆçš„è¯", "åƒé‡Œä¹‹å¤–", "èŠèŠ±å°", "å¤œæ›²", "å½©è™¹", "å‘å¦‚é›ª", "ç”œç”œçš„", "è’²å…¬è‹±çš„çº¦å®š", "æœ€é•¿çš„ç”µå½±",
            "æ±Ÿå—", "ä¸€åƒå¹´ä»¥å", "æ›¹æ“", "å°é…’çª", "ä¿®ç‚¼çˆ±æƒ…", "å¯æƒœæ²¡å¦‚æœ", "ä¸ä¸ºè°è€Œä½œçš„æ­Œ", "èƒŒå¯¹èƒŒæ‹¥æŠ±", "å¥¹è¯´", "ç¬¬å‡ ä¸ª100å¤©",
            "ç«¥è¯", "å‹‡æ°”", "æš–æš–", "åˆ†æ‰‹å¿«ä¹", "å´‡æ‹œ", "ç‡•å°¾è¶", "å®å¤", "æƒ…æ­Œ", "å¯æƒœä¸æ˜¯ä½ ", "ä¼šå‘¼å¸çš„ç—›",
            "å”¯ä¸€", "ä¾ç„¶çˆ±ä½ ", "å¤§åŸå°çˆ±", "æ”¹å˜è‡ªå·±", "å¿ƒä¸­çš„æ—¥æœˆ", "èŠ±ç”°é”™", "æˆ‘ä»¬çš„æ­Œ", "éœ€è¦äººé™ª", "ä½ ä¸çŸ¥é“çš„äº‹",
            "å»åˆ«", "ä¸€è·¯ä¸Šæœ‰ä½ ", "é¥è¿œçš„å¥¹", "æ¯å¤©çˆ±ä½ å¤šä¸€äº›", "é¥¿ç‹¼ä¼ è¯´", "å¤´å‘ä¹±äº†", "æ…¢æ…¢", "åªæƒ³ä¸€ç”Ÿè·Ÿä½ èµ°",
            "æµ·é˜”å¤©ç©º", "å…‰è¾‰å²æœˆ", "çœŸçš„çˆ±ä½ ", "ä¸å†çŠ¹è±«", "å–œæ¬¢ä½ ", "æƒ…äºº", "å¤§åœ°", "Amani",
            "çº¢è±†", "åŒ†åŒ†é‚£å¹´", "å› ä¸ºçˆ±æƒ…", "å®¹æ˜“å—ä¼¤çš„å¥³äºº", "æµå¹´", "ä¼ å¥‡", "äººé—´", "ç¬‘å¿˜ä¹¦",
            "å¤§é±¼", "èµ·é£äº†", "æ¶ˆæ„", "åƒæˆ‘è¿™æ ·çš„äºº", "å¹³å‡¡ä¹‹è·¯", "å—å±±å—", "å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ", "è¿½æ¢¦èµ¤å­å¿ƒ", "è“è²èŠ±", "æ›¾ç»çš„ä½ "
        ];
        
        const PUNISHMENTS = [
            "æ·±æƒ…æ¼”å”±è¿™é¦–æ­Œçš„å‰¯æ­Œ (30ç§’)", "æ¨¡ä»¿åŸå”±çš„ç»å…¸åŠ¨ä½œæ‹ç…§", "çœŸå¿ƒè¯ï¼šè¯´å‡ºä½ ç°åœ¨çš„å±ä¿æ˜¯è°", "ç”¨æ–¹è¨€æœ—è¯»è¿™é¦–æ­Œçš„æ­Œè¯",
            "å‘ä¸ªçº¢åŒ…ç»™èµ¢å®¶ (é‡‘é¢éšæ„)", "åš5ä¸ªæ·±è¹²å¹¶ä¸€è¾¹å”±è¿™é¦–æ­Œ", "è®©èµ¢å®¶åœ¨ä½ çš„è„¸ä¸Šç”»ä¸€ä¸ªå°å›¾æ¡ˆ", "å¤§å–Šä¸‰å£°ï¼šæˆ‘æ˜¯éº¦éœ¸ï¼"
        ];

        // --- P2P Global State ---
        let peer = null;
        let conn = null;
        let myRole = null; // 'host' or 'guest'
        let localPoisonSelection = null;
        
        let gameState = {
            status: 'waiting',
            songs: [],
            p1Poison: null, // Host Poison
            p2Poison: null, // Guest Poison
            sungSongs: [],
            currentTurn: 'host', // 'host' or 'guest'
            winner: null,
            punishment: '',
            rematchRequests: { host: false, guest: false }
        };

        // --- UI Functions ---
        function showScreen(name) {
            ['lobby', 'waiting', 'setup', 'battle', 'result'].forEach(id => {
                document.getElementById(`screen-${id}`).classList.add('hidden');
            });
            document.getElementById(`screen-${name}`).classList.remove('hidden');
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function log(msg) {
            console.log(msg);
            document.getElementById('connection-status').innerText = msg;
        }

        // --- P2P Logic ---

        function createRoom() {
            const roomId = Math.floor(Math.random() * 900000 + 100000).toString();
            const peerId = 'witch_game_' + roomId; 
            log("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...");
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                log("åˆ›å»ºæˆåŠŸï¼");
                myRole = 'host';
                document.getElementById('display-room-id').innerText = roomId;
                showScreen('waiting');
                startNewGame();
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
                gameState.status = 'setup';
                syncState();
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    alert("æˆ¿é—´å·ç”Ÿæˆå†²çªï¼Œè¯·é‡è¯•");
                    location.reload();
                } else {
                    alert("è¿æ¥é”™è¯¯: " + err.type);
                }
            });
        }

        function joinRoom() {
            const input = document.getElementById('room-code-input');
            const roomId = input.value.trim();
            if (roomId.length !== 6) { alert("è¯·è¾“å…¥6ä½æˆ¿é—´å·"); return; }

            const peerId = 'witch_game_' + roomId;
            log("æ­£åœ¨æŸ¥æ‰¾æˆ¿é—´...");
            peer = new Peer(); 

            peer.on('open', () => {
                conn = peer.connect(peerId);
                if(!conn) { alert("æ— æ³•è¿æ¥"); return; }
                myRole = 'guest';
                setupConnection();
            });

            peer.on('error', (err) => {
                alert("æ— æ³•è¿æ¥åˆ°æˆ¿é—´ï¼Œå¯èƒ½æˆ¿é—´å·é”™è¯¯æˆ–æˆ¿ä¸»å·²ç¦»çº¿");
            });
        }

        function setupConnection() {
            conn.on('open', () => { log("å·²è¿æ¥ï¼"); });
            conn.on('data', (data) => {
                if (data.type === 'SYNC') {
                    gameState = data.state;
                    renderGame();
                }
                if (myRole === 'host' && data.type === 'ACTION') {
                    handleGuestAction(data.payload);
                }
                if (data.type === 'EMOTE') {
                    showEmote(data.emoji);
                }
            });
            conn.on('close', () => {
                alert("å¯¹æ–¹å·²æ–­å¼€è¿æ¥");
                location.reload();
            });
        }

        function syncState() {
            renderGame();
            if (conn && conn.open) conn.send({ type: 'SYNC', state: gameState });
        }

        function sendEmote(emoji) {
            showEmote(emoji); // Show locally
            if (conn && conn.open) conn.send({ type: 'EMOTE', emoji: emoji });
        }

        function showEmote(emoji) {
            const container = document.getElementById('emote-container');
            const el = document.createElement('div');
            el.className = 'emote-float';
            el.innerText = emoji;
            // Randomize position slightly
            const randomX = Math.random() * 40 - 20; 
            el.style.transform = `translateX(${randomX}px)`;
            
            container.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // --- Game Logic ---

        function startNewGame() {
            gameState.songs = shuffle([...SONG_LIBRARY]).slice(0, 16);
            gameState.songs = shuffle(gameState.songs);
            gameState.punishment = PUNISHMENTS[Math.floor(Math.random() * PUNISHMENTS.length)];
            gameState.p1Poison = null;
            gameState.p2Poison = null;
            gameState.sungSongs = [];
            gameState.currentTurn = 'host';
            gameState.winner = null;
            gameState.rematchRequests = { host: false, guest: false };
            localPoisonSelection = null;
        }

        function handleGuestAction(payload) {
            if (payload.action === 'SET_POISON') {
                gameState.p2Poison = payload.index;
                checkSetupComplete();
            }
            if (payload.action === 'CLICK_SONG') {
                processTurn(payload.index);
            }
            if (payload.action === 'REMATCH') {
                gameState.rematchRequests.guest = true;
                checkRematch();
            }
            syncState();
        }

        function submitPoison() {
            if (localPoisonSelection === null) return;
            if (myRole === 'host') {
                gameState.p1Poison = localPoisonSelection;
                checkSetupComplete();
                syncState();
            } else {
                conn.send({ type: 'ACTION', payload: { action: 'SET_POISON', index: localPoisonSelection } });
            }
            document.getElementById('confirm-poison-btn').innerText = "ç­‰å¾…å¯¹æ–¹...";
            document.getElementById('confirm-poison-btn').disabled = true;
        }

        function checkSetupComplete() {
            if (gameState.p1Poison !== null && gameState.p2Poison !== null) {
                gameState.status = 'battle';
            }
        }

        function handleBattleClick(index) {
            if (myRole === 'host') {
                processTurn(index);
                syncState();
            } else {
                conn.send({ type: 'ACTION', payload: { action: 'CLICK_SONG', index: index } });
            }
        }

        function processTurn(index) {
            if (gameState.sungSongs.includes(index)) return;

            const currentActor = gameState.currentTurn; 
            const opponentPoison = currentActor === 'host' ? gameState.p2Poison : gameState.p1Poison;

            if (index === opponentPoison) {
                gameState.status = 'gameover';
                gameState.winner = currentActor === 'host' ? 'guest' : 'host';
                gameState.sungSongs.push(index);
            } else {
                gameState.sungSongs.push(index);
                gameState.currentTurn = currentActor === 'host' ? 'guest' : 'host';
            }
        }

        function requestRematch() {
            const btn = document.getElementById('rematch-btn');
            btn.innerText = "ç­‰å¾…å¯¹æ–¹...";
            btn.disabled = true;
            btn.classList.add('opacity-50');

            if (myRole === 'host') {
                gameState.rematchRequests.host = true;
                checkRematch();
                syncState();
            } else {
                conn.send({ type: 'ACTION', payload: { action: 'REMATCH' } });
            }
        }

        function checkRematch() {
            if (gameState.rematchRequests.host && gameState.rematchRequests.guest) {
                startNewGame();
                gameState.status = 'setup';
                // Reset UI for both via syncState
            }
        }

        // --- Render Logic ---

        function renderGame() {
            if (gameState.status === 'setup') {
                showScreen('setup');
                renderSetup();
            } else if (gameState.status === 'battle') {
                showScreen('battle');
                renderBattle();
            } else if (gameState.status === 'gameover') {
                showScreen('result');
                renderResult();
            }
        }

        function renderSetup() {
            const isMeReady = myRole === 'host' ? gameState.p1Poison !== null : gameState.p2Poison !== null;
            const isOpponentReady = myRole === 'host' ? gameState.p2Poison !== null : gameState.p1Poison !== null;

            const statusBadge = document.getElementById('setup-status');
            if (isMeReady && !isOpponentReady) {
                statusBadge.innerText = "ç­‰å¾…å¯¹æ–¹...";
                statusBadge.className = "status-badge bg-blue-100 text-blue-700 animate-pulse";
            } else if (!isMeReady) {
                statusBadge.innerText = "è¯·é€‰æ‹©";
                statusBadge.className = "status-badge bg-yellow-100 text-yellow-700";
            }

            const grid = document.getElementById('setup-grid');
            if (grid.children.length === 0) {
                gameState.songs.forEach((song, index) => {
                    const btn = document.createElement('button');
                    btn.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-gray-800 font-medium h-16 flex items-center justify-between transition-all active:scale-95";
                    btn.onclick = () => {
                        localPoisonSelection = index;
                        Array.from(grid.children).forEach(b => {
                            b.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-gray-800 font-medium h-16 flex items-center justify-between transition-all active:scale-95";
                            b.querySelector('span:last-child').innerHTML = 'ğŸµ';
                            b.querySelector('span:last-child').className = "text-xl opacity-30";
                        });
                        btn.className = "bg-blue-50 p-4 rounded-xl shadow-inner border-2 border-blue-500 text-blue-800 font-bold h-16 flex items-center justify-between transform scale-[0.98]";
                        btn.querySelector('span:last-child').innerHTML = 'â˜ ï¸';
                        btn.querySelector('span:last-child').className = "text-xl";

                        const cBtn = document.getElementById('confirm-poison-btn');
                        cBtn.disabled = false;
                        cBtn.className = "w-full max-w-md bg-[#0071e3] hover:bg-[#0077ED] text-white font-bold py-4 rounded-2xl transition-all duration-300 shadow-lg";
                        cBtn.innerText = "ç¡®è®¤ä¸‹æ¯’";
                    };
                    btn.innerHTML = `<span class="truncate text-sm">${song}</span><span class="text-xl opacity-30">ğŸµ</span>`;
                    grid.appendChild(btn);
                });
            }

            if (isMeReady) {
                 const cBtn = document.getElementById('confirm-poison-btn');
                 cBtn.innerText = "å·²ç¡®è®¤ï¼Œç­‰å¾…å¯¹æ–¹...";
                 cBtn.disabled = true;
                 cBtn.className = "w-full max-w-md bg-green-500 text-white font-bold py-4 rounded-2xl shadow-md";
            }
        }

        function renderBattle() {
            const isMyTurn = gameState.currentTurn === myRole;
            const statusText = document.getElementById('battle-status-text');
            const turnIndicator = document.getElementById('turn-indicator');
            const safeCount = document.getElementById('safe-count');

            if (isMyTurn) {
                statusText.innerText = "è½®åˆ°ä½ äº†ï¼è¯·ç‚¹æ­Œ";
                statusText.className = "text-lg font-bold text-[#0071e3] animate-pulse";
                turnIndicator.className = "bg-[#0071e3] h-1.5 rounded-full transition-all duration-500";
            } else {
                statusText.innerText = "å¯¹æ–¹æ­£åœ¨æ€è€ƒ...";
                statusText.className = "text-lg font-bold text-gray-500";
                turnIndicator.className = "bg-gray-300 h-1.5 rounded-full transition-all duration-500";
            }
            safeCount.innerText = 16 - gameState.sungSongs.length;

            const grid = document.getElementById('battle-grid');
            grid.innerHTML = '';
            gameState.songs.forEach((song, index) => {
                const isSung = gameState.sungSongs.includes(index);
                const btn = document.createElement('button');
                
                if (isSung) {
                     btn.className = "h-20 p-2 rounded-xl text-sm relative flex flex-col items-center justify-center font-bold shadow-sm bg-gray-100 border border-gray-200 text-gray-400 opacity-60 cursor-not-allowed";
                     btn.disabled = true;
                     btn.innerHTML = `<span class="line-through">${song}</span>`;
                } else {
                     if (isMyTurn) {
                        btn.className = "h-20 p-2 rounded-xl text-sm relative transition-all duration-300 flex flex-col items-center justify-center font-bold shadow-sm bg-white border border-gray-100 text-gray-800 hover:shadow-md active:scale-95 active:bg-gray-50";
                        btn.onclick = () => handleBattleClick(index);
                     } else {
                        btn.className = "h-20 p-2 rounded-xl text-sm relative flex flex-col items-center justify-center font-bold shadow-sm bg-white border border-gray-100 text-gray-800 opacity-80 cursor-wait";
                        btn.disabled = true;
                     }
                     btn.innerHTML = `<span class="z-10">${song}</span><div class="absolute bottom-1 right-2 text-gray-200 text-xs">ğŸ¤</div>`;
                }
                grid.appendChild(btn);
            });
        }

        function renderResult() {
            const isWinner = gameState.winner === myRole;
            const myPoisonIndex = myRole === 'host' ? gameState.p1Poison : gameState.p2Poison;
            const oppPoisonIndex = myRole === 'host' ? gameState.p2Poison : gameState.p1Poison;
            
            // Text updates
            const icon = document.getElementById('result-icon');
            const title = document.getElementById('result-title');
            const desc = document.getElementById('result-desc');
            const punish = document.getElementById('result-punishment');

            punish.innerText = gameState.punishment;

            if (isWinner) {
                icon.innerText = "ğŸ†";
                title.innerText = "èƒœåˆ©!";
                title.className = "text-3xl font-black text-[#0071e3] mb-1";
                desc.innerText = "å¯¹æ–¹å–ä¸‹äº†ä½ è®¾çš„æ¯’è¯";
            } else {
                icon.innerText = "ğŸ’¥";
                title.innerText = "å¤±è´¥!";
                title.className = "text-3xl font-black text-red-500 mb-1";
                desc.innerText = "ä½ å–ä¸‹äº†å¯¹æ–¹çš„æ¯’è¯";
            }

            // Rematch Button Reset
            const rBtn = document.getElementById('rematch-btn');
            const myRequest = myRole === 'host' ? gameState.rematchRequests.host : gameState.rematchRequests.guest;
            if (myRequest) {
                rBtn.innerText = "ç­‰å¾…å¯¹æ–¹...";
                rBtn.classList.add('opacity-50');
            } else {
                rBtn.innerText = "ğŸ”„ å†æ¥ä¸€å±€";
                rBtn.classList.remove('opacity-50');
                rBtn.disabled = false;
            }

            // Review Grid Render
            const grid = document.getElementById('review-grid');
            grid.innerHTML = '';
            gameState.songs.forEach((song, index) => {
                const el = document.createElement('div');
                let classes = "h-16 rounded-lg text-xs flex flex-col items-center justify-center font-bold relative p-1 text-center ";
                let content = `<span>${song}</span>`;

                const isSung = gameState.sungSongs.includes(index);
                const isMyPoison = (index === myPoisonIndex);
                const isOppPoison = (index === oppPoisonIndex);

                if (isMyPoison) {
                    classes += "bg-red-50 border-2 border-red-400 text-red-800 ";
                    content += `<div class="absolute -top-2 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[8px]">æˆ‘</div>`;
                } else if (isOppPoison) {
                    classes += "bg-purple-50 border-2 border-purple-400 text-purple-800 ";
                    content += `<div class="absolute -top-2 -right-1 bg-purple-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[8px]">TA</div>`;
                    if (isSung) content += `<div class="absolute inset-0 flex items-center justify-center text-4xl opacity-80">ğŸ’¥</div>`; // Fatal hit
                } else if (isSung) {
                    classes += "bg-gray-100 text-gray-400 border border-gray-200 ";
                } else {
                    classes += "bg-white text-gray-600 border border-gray-100 ";
                }

                el.className = classes;
                el.innerHTML = content;
                grid.appendChild(el);
            });
        }
    </script>
</body>
</html>
